<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>公交路线规划</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        
        .swap-container {
            display: flex;
            align-items: center;
            padding-bottom: 12px;
            margin-bottom: 15px;
        }
        
        .swap-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #4ec9b0;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
            flex-shrink: 0;
            line-height: 1;
            padding: 0;
        }
        
        .swap-btn:hover {
            background-color: #3ba996;
            transform: scale(1.05);
        }
        
        .swap-btn:active {
            transform: scale(0.95);
        }
        
        .input-item {
            flex: 1;
            margin-bottom: 15px;
        }
        
        .input-item-prepend {
            margin-bottom: 8px;
        }
        
        .input-item-text {
            font-weight: bold;
            color: #cccccc;
            font-size: 14px;
        }
        
        #cityinput, #startinput, #endinput, #departuretime {
            width: 100%;
            padding: 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #3c3c3c;
            color: #d4d4d4;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        #cityinput:focus, #startinput:focus, #endinput:focus, #departuretime:focus {
            outline: none;
            border-color: #0078d4;
            background-color: #404040;
        }
        
        #cityinput::placeholder, #startinput::placeholder, #endinput::placeholder, #departuretime::placeholder {
            color: #858585;
        }
        
        .search-btn {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            transition: background-color 0.2s;
            margin-top: 20px;
            width: 100%;
        }
        
        .search-btn:hover {
            background-color: #106ebe;
        }
        
        .search-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .result-container {
            margin-top: 20px;
            padding: 15px;
            border-left: 4px solid #0078d4;
            background-color: #2d2d30;
            border-radius: 4px;
        }
        
        .result-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #cccccc;
            font-size: 16px;
        }
        
        .route-item {
            margin-bottom: 15px;
            background-color: #252526;
            border-radius: 4px;
            border: 1px solid #3e3e42;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .route-header:hover {
            background-color: #2d2d30;
        }
        
        .route-header.expanded {
            border-bottom: 1px solid #3e3e42;
        }
        
        .route-title {
            color: #569cd6;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .expand-icon {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #569cd6;
            transition: transform 0.3s ease;
            transform-origin: center;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .route-summary {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .route-time, .route-cost, .route-distance {
            color: #ce9178;
            font-size: 14px;
        }
        
        .route-transport {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .transport-badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .transport-badge.walk {
            background-color: #4ec9b0;
        }
        
        .transport-badge.bus {
            background-color: #dcdcaa;
        }
        
        .transport-badge.metro {
            background-color: #c586c0;
        }
        
        .route-steps {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .route-steps.expanded {
            max-height: 2000px;
        }
        
        .route-steps-content {
            padding: 0 15px 15px 15px;
        }
        
        .step-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 8px;
            background-color: #1e1e1e;
            border-radius: 4px;
        }
        
        .step-icon {
            width: 30px;
            height: 30px;
            background-color: #0078d4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .step-icon.walk {
            background-color: #4ec9b0;
        }
        
        .step-icon.bus {
            background-color: #dcdcaa;
        }
        
        .step-icon.metro {
            background-color: #c586c0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-instruction {
            color: #d4d4d4;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .step-details {
            color: #858585;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }
        
        .subway-stops {
            margin-top: 8px;
            padding-left: 42px;
            font-size: 12px;
            color: #9cdcfe;
        }
        
        .subway-stops-header {
            cursor: pointer;
            color: #569cd6;
            font-size: 12px;
            margin-bottom: 4px;
            user-select: none;
            transition: color 0.2s;
        }
        
        .subway-stops-header:hover {
            color: #4a9eff;
            text-decoration: underline;
        }
        
        .subway-stops-list {
            display: none;
            line-height: 1.4;
            margin-left: 8px;
        }
        
        .subway-stops-list.expanded {
            display: block;
        }
        
        .subway-stop-item {
            padding: 2px 0;
            border-left: 2px solid #569cd6;
            padding-left: 8px;
            margin-bottom: 2px;
        }
        
        .subway-stop-item:last-child {
            border-left-color: #c586c0;
        }
        
        .om-walk-link {
            color: #569cd6;
            text-decoration: none;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: #1e1e1e;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        .om-walk-link:hover {
            background-color: #3c3c3c;
            text-decoration: underline;
        }
        
        .autocomplete-container {
            position: relative;
        }
        
        .amap-sug-result {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #252526;
            border: 1px solid #3e3e42;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 0 0 4px 4px;
        }
        
        .amap-sug-result .auto-item {
            padding: 8px 12px;
            color: #d4d4d4;
            cursor: pointer;
            border-bottom: 1px solid #3e3e42;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            font-size: 13px;
        }
        
        .amap-sug-result .auto-item:hover {
            background-color: #3c3c3c;
        }
        
        .amap-sug-result .auto-item:last-child {
            border-bottom: none;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #cccccc;
            padding: 20px;
        }
        
        .error {
            color: #f48771;
            background-color: #2d1b1b;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #8c2d2d;
        }
        
        .policy-selector {
            margin-bottom: 15px;
        }
        
        #policy-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background-color: #3c3c3c;
            color: #d4d4d4;
            font-family: Arial, sans-serif, 'Courier New', monospace;
        }
        

    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #cccccc; margin-bottom: 30px; font-weight: 300; font-size: 24px;">公交路线规划</h1>
        
        <div class="input-group">
            <div class="input-item">
                <div class="input-item-prepend">
                    <span class="input-item-text">城市</span>
                </div>
                <input id='cityinput' type="text" placeholder="输入城市名称（如：北京、上海）">
            </div>
            <div class="input-item">
                <div class="input-item-prepend">
                    <span class="input-item-text">出发时间</span>
                </div>
                <input id='departuretime' type="text" placeholder="例如：8、14:30、18:30">
            </div>
        </div>
        
        <div class="input-group">
            <div class="input-item">
                <div class="input-item-prepend">
                    <span class="input-item-text">起点</span>
                </div>
                <div class="autocomplete-container">
                    <input id='startinput' type="text" placeholder="输入起点地址或地点名称">
                </div>
            </div>
            <div class="swap-container">
                <button id="swap-btn" class="swap-btn" onclick="swapStartEnd()" title="交换起终点">⇄</button>
            </div>
            <div class="input-item">
                <div class="input-item-prepend">
                    <span class="input-item-text">终点</span>
                </div>
                <div class="autocomplete-container">
                    <input id='endinput' type="text" placeholder="输入终点地址或地点名称">
                </div>
            </div>
        </div>
        
        <div class="policy-selector">
            <div class="input-item-prepend">
                <span class="input-item-text">路线选择依据</span>
            </div>
            <select id="policy-select">
                <option value="LEAST_TIME">最快捷</option>
                <option value="LEAST_SWAP">最少换乘</option>
                <option value="LEAST_WALK">最少步行</option>
                <option value="MOST_COMFORT">最舒适</option>
                <option value="NO_SUBWAY">不乘地铁</option>
            </select>
        </div>
        
        <button id="search-btn" class="search-btn">规划路线</button>
        
        <div id="loading" class="loading hidden">
            正在规划路线...
        </div>
        
        <div id="error" class="error hidden"></div>
        
        <div id="result" class="result-container hidden">
            <div class="result-title">路线方案</div>
            <div id="routes-container"></div>
        </div>
    </div>

    <!-- 引入高德地图API -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=你的高德apiKEY&plugin=AMap.Transfer,AMap.PlaceSearch"></script>
    
    <!-- 坐标转换函数 -->
    <script type="text/javascript">
        // eviltransform.js - 坐标转换库
        // 来源：https://github.com/googollee/eviltransform/blob/master/javascript/transform.js
        
        function outOfChina(lat, lng) {
            if (lng < 72.004 || lng > 137.8347)
                return true;
            if (lat < 0.8293 || lat > 55.8271)
                return true;
            return false;
        }
        var earthR = 6378137.0;
        function transform(x, y) {
            var xy = x * y;
            var absX = Math.sqrt(Math.abs(x));
            var xPi = x * Math.PI;
            var yPi = y * Math.PI;
            var d = 20.0*Math.sin(6.0*xPi) + 20.0*Math.sin(2.0*xPi);

            var lat = d;
            var lng = d;

            lat += 20.0*Math.sin(yPi) + 40.0*Math.sin(yPi/3.0);
            lng += 20.0*Math.sin(xPi) + 40.0*Math.sin(xPi/3.0);

            lat += 160.0*Math.sin(yPi/12.0) + 320*Math.sin(yPi/30.0);
            lng += 150.0*Math.sin(xPi/12.0) + 300.0*Math.sin(xPi/30.0);

            lat *= 2.0 / 3.0;
            lng *= 2.0 / 3.0;

            lat += -100.0 + 2.0*x + 3.0*y + 0.2*y*y + 0.1*xy + 0.2*absX;
            lng += 300.0 + x + 2.0*y + 0.1*x*x + 0.1*xy + 0.1*absX;

            return {lat: lat, lng: lng}
        }
        function delta(lat, lng) {
            var ee = 0.00669342162296594323;
            var d = transform(lng-105.0, lat-35.0);
            var radLat = lat / 180.0 * Math.PI;
            var magic = Math.sin(radLat);
            magic = 1 - ee*magic*magic;
            var sqrtMagic = Math.sqrt(magic);
            d.lat = (d.lat * 180.0) / ((earthR * (1 - ee)) / (magic * sqrtMagic) * Math.PI);
            d.lng = (d.lng * 180.0) / (earthR / sqrtMagic * Math.cos(radLat) * Math.PI);
            return d;
        }
        
        function gcj2wgs_exact(gcjLat, gcjLng) {
            var newLat = gcjLat, newLng = gcjLng;
            var oldLat = newLat, oldLng = newLng;
            var threshold = 1e-6; 

            for (var i = 0; i < 50; i++) {
                oldLat = newLat;
                oldLng = newLng;
                var d = delta(newLat, newLng);
                newLat = gcjLat - d.lat;
                newLng = gcjLng - d.lng;
                if (Math.max(Math.abs(oldLat - newLat), Math.abs(oldLng - newLng)) < threshold) {
                    break;
                }
            }
            return {lat: newLat, lng: newLng};
        }
    </script>
    
    <script type="text/javascript">
        // 全局变量
        var startLocation = null;
        var endLocation = null;
        var currentCity = '';
        var startAuto = null;
        var endAuto = null;
        var startPlaceSearch = null;
        var endPlaceSearch = null;
        
        // 加载时恢复上一次的城市选择
        window.addEventListener('DOMContentLoaded', function() {
            var savedCity = localStorage.getItem('selectedCity');
            if (savedCity) {
                document.getElementById('cityinput').value = savedCity;
                currentCity = savedCity;
            }
            
            // 恢复上一次的起点和终点
            var savedStart = localStorage.getItem('selectedStart');
            if (savedStart) {
                document.getElementById('startinput').value = savedStart;
            }
            
            var savedEnd = localStorage.getItem('selectedEnd');
            if (savedEnd) {
                document.getElementById('endinput').value = savedEnd;
            }
            
            // 设置默认出发时间为当前时间
            setDefaultDepartureTime();
            
            // 设置自动完成
            setupAutocomplete();
        });
        
        // 设置默认出发时间
        function setDefaultDepartureTime() {
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var timeString = hours + ':' + (minutes < 10 ? '0' + minutes : minutes);
            document.getElementById('departuretime').value = timeString;
        }
        
        // 智能转换时间格式
        function parseTimeInput(input) {
            input = input.trim();
            if (!input) return null;
            
            // 处理纯数字（如：8、15、23）
            if (/^\d+$/.test(input)) {
                var hour = parseInt(input);
                if (hour >= 0 && hour <= 23) {
                    return hour + ':00';
                }
            }
            
            // 处理小时:分钟格式（如：8:30、14:30、8:3）
            if (/^\d{1,2}:\d{1,2}$/.test(input)) {
                var parts = input.split(':');
                var hour = parseInt(parts[0]);
                var minute = parseInt(parts[1]);
                
                if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                    return hour + ':' + (minute < 10 ? '0' + minute : minute);
                }
            }
            
            // 处理带冒号的三位数（如：8:3 转换为 8:30）
            if (/^\d{1,2}:\d$/.test(input)) {
                var parts = input.split(':');
                var hour = parseInt(parts[0]);
                var minute = parseInt(parts[1]) * 10; // 将个位数转换为整十分钟
                
                if (hour >= 0 && hour <= 23 && minute <= 50) {
                    return hour + ':' + (minute < 10 ? '0' + minute : minute);
                }
            }
            
            return null; // 无效格式
        }
        
        // 获取出发时间戳（用于API调用）
        function getDepartureTimestamp() {
            var timeInput = document.getElementById('departuretime').value;
            var parsedTime = parseTimeInput(timeInput);
            
            if (!parsedTime) {
                return null; // 使用API默认（当前时间）
            }
            
            var now = new Date();
            var parts = parsedTime.split(':');
            var departureDate = new Date();
            departureDate.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);
            
            // 如果设定的时间已经过去，设置为明天
            if (departureDate.getTime() < now.getTime()) {
                departureDate.setDate(departureDate.getDate() + 1);
            }
            
            return Math.floor(departureDate.getTime() / 1000); // 转换为秒时间戳
        }
        
        // 设置自动完成
        function setupAutocomplete() {
            var city = getCurrentCity();
            
            // 地点搜索服务
            startPlaceSearch = new AMap.PlaceSearch({
                city: city,
                pageSize: 5
            });
            
            endPlaceSearch = new AMap.PlaceSearch({
                city: city,
                pageSize: 5
            });
            
            // 设置输入提示
            setupInputSuggestion('startinput', startPlaceSearch, function(location) {
                startLocation = location;
            });
            
            setupInputSuggestion('endinput', endPlaceSearch, function(location) {
                endLocation = location;
            });
        }
        
        // 设置输入提示功能
        function setupInputSuggestion(inputId, placeSearch, onLocationSet) {
            var inputElement = document.getElementById(inputId);
            var suggestionDiv = null;
            var currentSuggestions = [];
            var selectedIndex = -1;
            
            // 创建建议下拉框
            function createSuggestionDiv() {
                if (suggestionDiv) {
                    suggestionDiv.remove();
                }
                
                suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'amap-sug-result';
                suggestionDiv.style.display = 'none';
                inputElement.parentNode.appendChild(suggestionDiv);
            }
            
            // 显示建议
            function showSuggestions(suggestions) {
                createSuggestionDiv();
                currentSuggestions = suggestions;
                selectedIndex = -1;
                
                suggestionDiv.innerHTML = '';
                suggestions.forEach(function(item, index) {
                    var div = document.createElement('div');
                    div.className = 'auto-item';
                    div.textContent = item.name + ' - ' + item.address;
                    div.addEventListener('click', function() {
                        inputElement.value = item.name + ' - ' + item.address;
                        if (item.location) {
                            onLocationSet(item.location);

                        }
                        hideSuggestions();
                    });
                    suggestionDiv.appendChild(div);
                });
                
                suggestionDiv.style.display = suggestions.length > 0 ? 'block' : 'none';
            }
            
            // 隐藏建议
            function hideSuggestions() {
                if (suggestionDiv) {
                    suggestionDiv.style.display = 'none';
                }
            }
            
            // 搜索建议
            function searchSuggestions(keyword) {
                if (keyword.length < 2) {
                    hideSuggestions();
                    return;
                }
                
                placeSearch.search(keyword, function(status, result) {
                    if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                        showSuggestions(result.poiList.pois);
                    } else {
                        hideSuggestions();
                    }
                });
            }
            
            // 键盘事件处理
            inputElement.addEventListener('input', function(e) {
                var keyword = e.target.value.trim();
                searchSuggestions(keyword);
            });
            
            inputElement.addEventListener('keydown', function(e) {
                if (!currentSuggestions.length) return;
                
                var items = suggestionDiv.querySelectorAll('.auto-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0) {
                        items[selectedIndex].click();
                    } else {
                        hideSuggestions();
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });
            
            // 更新选中状态
            function updateSelection(items) {
                items.forEach(function(item, index) {
                    if (index === selectedIndex) {
                        item.style.backgroundColor = '#3c3c3c';
                    } else {
                        item.style.backgroundColor = 'transparent';
                    }
                });
            }
            
            // 点击其他地方隐藏建议
            document.addEventListener('click', function(e) {
                if (!inputElement.contains(e.target) && (!suggestionDiv || !suggestionDiv.contains(e.target))) {
                    hideSuggestions();
                }
            });
        }
        
        // 保存城市选择
        function saveCity(city) {
            if (city && city.trim()) {
                localStorage.setItem('selectedCity', city.trim());
                currentCity = city.trim();
                // 重新设置自动完成的城市
                setupAutocomplete();
            }
        }
        
        // 保存起点和终点
        function saveStartEnd() {
            var startValue = document.getElementById('startinput').value.trim();
            var endValue = document.getElementById('endinput').value.trim();
            
            if (startValue) {
                localStorage.setItem('selectedStart', startValue);
            }
            
            if (endValue) {
                localStorage.setItem('selectedEnd', endValue);
            }
        }
        
        // 交换起点和终点
        function swapStartEnd() {
            var startInput = document.getElementById('startinput');
            var endInput = document.getElementById('endinput');
            var startValue = startInput.value;
            var endValue = endInput.value;
            
            // 交换值
            startInput.value = endValue;
            endInput.value = startValue;
            
            // 交换位置变量
            var tempLocation = startLocation;
            startLocation = endLocation;
            endLocation = tempLocation;
            
            // 保存到本地存储
            saveStartEnd();
            
            // 清空并重新设置自动完成
            startLocation = null;
            endLocation = null;
        }
        
        // 获取当前城市
        function getCurrentCity() {
            return document.getElementById('cityinput').value.trim() || '全国';
        }
        
        // 城市输入框失去焦点时保存
        document.getElementById('cityinput').addEventListener('blur', function() {
            saveCity(this.value);
        });
        
        // 起点和终点输入框失去焦点时保存
        document.getElementById('startinput').addEventListener('blur', function() {
            saveStartEnd();
        });
        
        document.getElementById('endinput').addEventListener('blur', function() {
            saveStartEnd();
        });
        
        // 地点搜索服务
        function searchLocation(keyword, city, isStart, callback) {
            var placeSearch = isStart ? startPlaceSearch : endPlaceSearch;
            placeSearch.setCity(city);
            placeSearch.search(keyword, function(status, result) {
                if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                    var poi = result.poiList.pois[0];
                    if (poi.location) {
                        callback(poi.location);
                    } else {
                        callback(null);
                    }
                } else {
                    callback(null);
                }
            });
        }
        
        // 获取策略值
        function getPolicyValue() {
            var policySelect = document.getElementById('policy-select').value;
            switch(policySelect) {
                case 'LEAST_TIME': return AMap.TransferPolicy.LEAST_TIME;
                case 'LEAST_SWAP': return AMap.TransferPolicy.LEAST_SWAP;
                case 'LEAST_WALK': return AMap.TransferPolicy.LEAST_WALK;
                case 'MOST_COMFORT': return AMap.TransferPolicy.MOST_COMFORT;
                case 'NO_SUBWAY': return AMap.TransferPolicy.NO_SUBWAY;
                default: return AMap.TransferPolicy.LEAST_TIME;
            }
        }
        
        // 格式化时间
        function formatDuration(seconds) {
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return hours + '小时' + minutes + '分钟';
            } else {
                return minutes + '分钟';
            }
        }
        
        // 格式化距离
        function formatDistance(meters) {
            if (meters >= 1000) {
                return (meters / 1000).toFixed(1) + '公里';
            } else {
                return Math.round(meters) + '米';
            }
        }
        
        // 获取步骤图标
        function getStepIcon(instruction) {
            if (instruction.indexOf('步行') >= 0 || instruction.indexOf('走路') >= 0) {
                return 'walk';
            } else if (instruction.indexOf('地铁') >= 0 || instruction.indexOf('MTR') >= 0) {
                return 'metro';
            } else {
                return 'bus';
            }
        }
        
        // 获取交通方式摘要
        function getTransportSummary(segments) {
            var transportTypes = [];
            var hasWalking = false;
            
            segments.forEach(function(segment) {
                if (segment.transit_mode === 'WALK') {
                    hasWalking = true;
                } else if (segment.transit_mode === 'SUBWAY') {
                    if (!transportTypes.includes('地铁')) {
                        transportTypes.push('地铁');
                    }
                } else if (segment.transit_mode === 'BUS') {
                    if (!transportTypes.includes('公交')) {
                        transportTypes.push('公交');
                    }
                }
            });
            
            if (hasWalking && transportTypes.length > 0) {
                transportTypes.push('步行');
            } else if (hasWalking) {
                transportTypes = ['步行'];
            }
            
            return transportTypes;
        }
        
        // 计算步行总距离
        function getWalkingDistance(segments) {
            var walkingDistance = 0;
            segments.forEach(function(segment) {
                if (segment.transit_mode === 'WALK' && segment.distance) {
                    walkingDistance += segment.distance;
                }
            });
            return walkingDistance;
        }
        
        // 获取高德API返回的实际费用
        function getActualCost(route) {
            // 高德API返回的数据中，费用信息通常在route对象的某个属性中
            // 根据高德地图文档，费用信息通常在route.cost属性中
            if (route.cost !== undefined && route.cost !== null) {
                return route.cost;
            }
            
            // 如果route.cost不存在，尝试从segments中查找费用信息
            var totalCost = 0;
            if (route.segments && route.segments.length > 0) {
                route.segments.forEach(function(segment) {
                    if (segment.cost !== undefined && segment.cost !== null) {
                        totalCost += segment.cost;
                    }
                });
                return totalCost > 0 ? totalCost : null;
            }
            
            // 如果都没有找到费用信息，返回null
            return null;
        }
        
        // 检查是否为站内换乘（步行前后都是地铁，且前一个地铁没有出站口）
        function checkStationTransfer(allSegments, currentIndex) {
            // 如果是第一个或最后一个步行路段，不可能是站内换乘
            if (currentIndex === 0 || currentIndex === allSegments.length - 1) {
                return false;
            }
            
            var prevSegment = allSegments[currentIndex - 1];
            var nextSegment = allSegments[currentIndex + 1];
            
            // 严格检查前一个路段是否为地铁（只根据transit_mode判断）
            var prevIsSubway = prevSegment && prevSegment.transit_mode === 'SUBWAY';
            
            // 严格检查后一个路段是否为地铁（只根据transit_mode判断）
            var nextIsSubway = nextSegment && nextSegment.transit_mode === 'SUBWAY';
            
            // 检查前一个地铁路段是否有出站口信息（只根据transit.exit属性判断）
            var prevHasExit = false;
            if (prevIsSubway && prevSegment && prevSegment.transit && prevSegment.transit.exit && prevSegment.transit.exit.name) {
                prevHasExit = true;
            }
            

            
            // 只有当前后都是地铁且前一个地铁没有出站口时，才是站内换乘
            return prevIsSubway && nextIsSubway && !prevHasExit;
        }
        
        // 格式化地铁路段的显示内容
        function formatSubwayInstruction(segment) {
            try {
                var instruction = segment.instruction || '';
                
                // 尝试从不同字段提取地铁信息
                var subwayInfo = {
                    line: '',          // 地铁线路
                    direction: '',     // 方向
                    stations: '',      // 乘坐站数
                    exit: ''          // 出站口
                };
                
                // 从指令中提取线路信息
                var lineMatch = instruction.match(/(\d+号线|\w+线|Line\s*\w+)/i);
                if (lineMatch) {
                    subwayInfo.line = lineMatch[1];
                }
                
                // 优先从via_stops中提取方向信息（下一个站点的名称）
                if (segment.transit && segment.transit.via_stops && segment.transit.via_stops.length > 0) {
                    // 获取第一个途径站点的名称作为方向
                    var nextStop = segment.transit.via_stops[0];
                    if (nextStop && nextStop.name) {
                        subwayInfo.direction = nextStop.name;

                    }
                }
                
                // 如果via_stops中没有找到，再从指令中提取
                if (!subwayInfo.direction) {
                    var directionMatch = instruction.match(/(?:往|向|开往|方向)([^，,，。]+)/);
                    if (directionMatch) {
                        subwayInfo.direction = directionMatch[1].trim();
                    }
                }
                
                // 从指令中提取乘坐站数（用于显示总数）
                var stationsMatch = instruction.match(/(?:乘坐|经过|途径)(\d+)站/);
                if (stationsMatch) {
                    subwayInfo.totalStations = parseInt(stationsMatch[1]);
                }
                
                // 从指令中提取终点站（下车点）
                var destinationMatch = instruction.match(/(?:到达|在)([^站，,，。]+)站?(?:到达|下车)/);
                if (destinationMatch) {
                    subwayInfo.destination = destinationMatch[1] + '站';
                } else if (instruction.match(/到达([^，,，。]+站)/)) {
                    var destMatch = instruction.match(/到达([^，,，。]+站)/);
                    if (destMatch) {
                        subwayInfo.destination = destMatch[1];
                    }
                }
                
                // 优先从exit对象中提取出站口信息
                if (segment.transit && segment.transit.exit && segment.transit.exit.name) {
                    subwayInfo.exit = segment.transit.exit.name;

                } else {
                    // 如果exit对象中没有找到，再从指令中提取
                    var exitMatch = instruction.match(/([A-Z0-9]+号?出站口|[A-Z0-9]+出站口|出站口[A-Z0-9]+)/i);
                    if (exitMatch) {
                        subwayInfo.exit = exitMatch[1];
                    }
                }
                
                // 尝试从transit字段获取更多信息
                if (segment.transit) {
                    // 尝试获取线路名称
                    if (segment.transit.lines && segment.transit.lines.length > 0) {
                        var firstLine = segment.transit.lines[0];
                        if (firstLine.name) {
                            subwayInfo.line = firstLine.name;
                        }
                    }
                    
                    // 尝试获取起点和终点站
                    if (segment.transit.on_station) {
                        subwayInfo.fromStation = segment.transit.on_station.name;
                    }
                    if (segment.transit.off_station) {
                        subwayInfo.off_station = segment.transit.off_station.name + '站';
                    }
                    // 尝试获取方向信息
                    if (segment.transit.direction) {
                        subwayInfo.direction = segment.transit.direction;
                    }
                }
                

                
                // 构建格式化指令
                var parts = [];
                
                if (subwayInfo.line) {
                    parts.push(subwayInfo.line);
                }
                
                if (subwayInfo.direction) {
                    parts.push('下一站：' + subwayInfo.direction);
                }
                
                if (subwayInfo.stations) {
                    parts.push('乘坐' + subwayInfo.stations);
                }
                
                
                var result = parts.join('，');
                
                
                return result || instruction; // 如果格式化失败，返回原始指令
                
            } catch (error) {

                return segment.instruction; // 出错时返回原始指令
            }
        }
        
        // 生成步行OM链接
        function generateWalkOMLink(segment) {
            // 检查是否是步行路段
            if (!segment.transit_mode || segment.transit_mode !== 'WALK') {
                return '';
            }
            

            
            // 从不同可能的属性获取坐标
            var startLocation = null;
            var endLocation = null;
            

            
            // 尝试从origin获取起点坐标
            if (segment.transit && segment.transit.origin) {

                
                // 如果是数组格式 [lng, lat]
                if (Array.isArray(segment.transit.origin) && segment.transit.origin.length >= 2) {
                    startLocation = {
                        lng: segment.transit.origin[0],
                        lat: segment.transit.origin[1]
                    };

                } 
                // 如果是对象格式 {lng: xxx, lat: xxx} 或 {longitude: xxx, latitude: xxx}
                else if (typeof segment.transit.origin === 'object') {
                    var lng = segment.transit.origin.lng || segment.transit.origin.longitude;
                    var lat = segment.transit.origin.lat || segment.transit.origin.latitude;
                    if (typeof lng === 'number' && typeof lat === 'number') {
                        startLocation = {
                            lng: lng,
                            lat: lat
                        };

                    }
                }
            }
            
            // 尝试从destination获取终点坐标
            if (segment.transit && segment.transit.destination) {

                
                // 如果是数组格式 [lng, lat]
                if (Array.isArray(segment.transit.destination) && segment.transit.destination.length >= 2) {
                    endLocation = {
                        lng: segment.transit.destination[0],
                        lat: segment.transit.destination[1]
                    };

                } 
                // 如果是对象格式 {lng: xxx, lat: xxx} 或 {longitude: xxx, latitude: xxx}
                else if (typeof segment.transit.destination === 'object') {
                    var lng = segment.transit.destination.lng || segment.transit.destination.longitude;
                    var lat = segment.transit.destination.lat || segment.transit.destination.latitude;
                    if (typeof lng === 'number' && typeof lat === 'number') {
                        endLocation = {
                            lng: lng,
                            lat: lat
                        };

                    }
                }
            }
            
            // 如果还没有找到，尝试从steps的路径中获取第一个和最后一个点
            if ((!startLocation || !endLocation) && segment.transit && segment.transit.steps && segment.transit.steps.length > 0) {

                
                if (!startLocation) {
                    var firstStep = segment.transit.steps[0];
                    if (firstStep.path && firstStep.path.length > 0) {
                        var firstPath = firstStep.path[0];
                        if (Array.isArray(firstPath) && firstPath.length >= 2) {
                            startLocation = {
                                lng: firstPath[0],
                                lat: firstPath[1]
                            };

                        }
                    }
                }
                
                if (!endLocation) {
                    var lastStep = segment.transit.steps[segment.transit.steps.length - 1];
                    if (lastStep.path && lastStep.path.length > 0) {
                        var lastPath = lastStep.path[lastStep.path.length - 1];
                        if (Array.isArray(lastPath) && lastPath.length >= 2) {
                            endLocation = {
                                lng: lastPath[0],
                                lat: lastPath[1]
                            };

                        }
                    }
                }
            }
            
            if (!startLocation || !endLocation) {

                return '';
            }
            

            
            var startGcjLat = startLocation.lat;
            var startGcjLng = startLocation.lng;
            var endGcjLat = endLocation.lat;
            var endGcjLng = endLocation.lng;
            

            
            // 检查坐标是否为有效数字
            if (isNaN(startGcjLat) || isNaN(startGcjLng) || isNaN(endGcjLat) || isNaN(endGcjLng)) {

                return '';
            }
            
            try {
                // 转换为WGS-84坐标
                var startWgs = gcj2wgs_exact(startGcjLat, startGcjLng);
                var endWgs = gcj2wgs_exact(endGcjLat, endGcjLng);
                

                
                // 检查转换后的坐标是否有效
                if (isNaN(startWgs.lat) || isNaN(startWgs.lng) || isNaN(endWgs.lat) || isNaN(endWgs.lng)) {

                    return '';
                }
                
                // 构建起点和终点地址
                var saddr = '步行起点';
                var daddr = '步行终点';
                
                // 从instruction中提取地点信息
                var instruction = segment.instruction || '';
                if (instruction) {
                    // 尝试从指令中提取地点名称
                    var matches = instruction.match(/到达(.+)/);
                    if (matches && matches[1]) {
                        daddr = matches[1].trim();
                    }
                }
                
                // 编码地址
                saddr = encodeURIComponent(saddr);
                daddr = encodeURIComponent(daddr);
                
                // 生成OM链接
                var omLink = 'om://route?sll=' + startWgs.lat.toFixed(7) + ',' + startWgs.lng.toFixed(7) + 
                            '&saddr=' + saddr + '&dll=' + endWgs.lat.toFixed(7) + ',' + endWgs.lng.toFixed(7) + 
                            '&daddr=' + daddr + '&type=pedestrian';
                

                return '<a href="' + omLink + '" class="om-walk-link" title="在OM中打开步行导航">导航</a>';
                
            } catch (error) {

                return '';
            }
        }
        
        // 渲染地铁站点列表
        function renderSubwayStops(segment, segmentIndex, stepIndex) {
            // 检查是否有地铁站点信息
            if (!segment.transit || !segment.transit.via_stops || segment.transit.via_stops.length === 0) {
                return '';
            }
            
            var uniqueId = 'subway-stops-' + segmentIndex + '-' + stepIndex;
            var stops = segment.transit.via_stops;
            var stopsHtml = '';
            
            // 添加on_station作为第一站（上车站）
            if (segment.transit.on_station && segment.transit.on_station.name) {
                var onStationName = segment.transit.on_station.name;
                stopsHtml += `<div class="subway-stop-item" style="border-left-color: #CE9178; font-weight: bold;">${onStationName}</div>`;
            }
            
            // 生成站点列表
            stops.forEach(function(stop, index) {
                stopsHtml += `<div class="subway-stop-item">${stop.name}</div>`;
            });
            
            // 添加off_station作为最后一站
            if (segment.transit.off_station && segment.transit.off_station.name) {
                var offStationName = segment.transit.off_station.name;
                // 如果名称已经包含"站"字，直接使用；否则添加"站"
                if (!offStationName.endsWith('站')) {
                    offStationName += '站';
                }
                stopsHtml += `<div class="subway-stop-item">${offStationName}</div>`;
            }
            
            // 计算总站点数（包括on_station和off_station）
            var totalStops = stops.length;
            if (segment.transit.on_station && segment.transit.on_station.name) {
                totalStops++;
            }
            if (segment.transit.off_station && segment.transit.off_station.name) {
                totalStops++;
            }
            // 途经站点数 = 总站点数 - 1（去掉上车站和下车站）
            var viaStopsCount = Math.max(0, totalStops - 1);
            
            // 构建下车站和出站口信息
            var stationInfoHtml = '';
            if (segment.transit.off_station && segment.transit.off_station.name) {
                var offStationName = segment.transit.off_station.name;
                
                
                // 添加出站口信息
                var exitInfo = '';
                if (segment.transit.exit && segment.transit.exit.name) {
                    exitInfo = segment.transit.exit.name;
                } else {
                    // 尝试从指令中提取出站口信息
                    var instruction = segment.instruction || '';
                    var exitMatch = instruction.match(/([A-Z0-9]+号?出站口|[A-Z0-9]+出站口|出站口[A-Z0-9]+)/i);
                    if (exitMatch) {
                        exitInfo = exitMatch[1];
                    }
                }
                if (exitInfo!="") {
                    stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #c586c0;font-size: 12px;">下车站： ${offStationName}&nbsp;&nbsp;&nbsp;&nbsp;出站口: ${exitInfo}</div>`;
                } else {
                    stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #c586c0;font-size: 12px;">下车站： ${offStationName}</div>`;
                }
                
            }
            
            return `
                <div class="subway-stops">
                    <div class="subway-stops-header" onclick="toggleSubwayStops('${uniqueId}')">
                        ▶ 乘坐 ${viaStopsCount} 站
                    </div>
                    <div id="${uniqueId}" class="subway-stops-list">
                        ${stopsHtml}
                    </div></div>
                    ${stationInfoHtml}
                
            `;
        }
        
        // 切换地铁站点列表显示
        function toggleSubwayStops(uniqueId) {
            var stopsList = document.getElementById(uniqueId);
            var header = stopsList.previousElementSibling;
            
            if (stopsList.classList.contains('expanded')) {
                stopsList.classList.remove('expanded');
                header.innerHTML = '▶ 途经 ' + stopsList.children.length + ' 个站点';
            } else {
                stopsList.classList.add('expanded');
                header.innerHTML = '▼ 途经 ' + stopsList.children.length + ' 个站点';
            }
        }
        
        // 渲染路线步骤
        function renderSteps(segments) {

            var stepsHtml = '<div class="route-steps-content">';
            
            segments.forEach(function(segment, index) {

                
                var iconClass = getStepIcon(segment.instruction);
                var iconText = iconClass === 'walk' ? '步' : (iconClass === 'metro' ? '铁' : '车');
                
                // 获取步骤的基本信息
                var durationInfo = segment.duration ? formatDuration(segment.duration) : '';
                var distanceInfo = segment.distance ? formatDistance(segment.distance) : '';
                var walkLink = '';
                
                // 如果是步行路段，检查是否为站内换乘，否则生成OM导航链接
                if (segment.transit_mode === 'WALK') {

                    
                    // 检查前后路段是否都是地铁
                    var isStationTransfer = checkStationTransfer(segments, index);
                    
                    if (isStationTransfer) {
                        walkLink = '<span style="color: #c586c0; font-size: 12px;">站内换乘</span>';

                    } else {
                        walkLink = generateWalkOMLink(segment);

                    }
                } else {

                }
                
                // 处理地铁路段的特殊显示格式
                var instruction = segment.instruction;
                var subwayStopsHtml = '';
                
                // 如果是地铁路段，重新格式化显示内容
                if (segment.transit_mode === 'SUBWAY' || 
                    (segment.transit_mode === 'RAILWAY' && instruction.includes('地铁')) ||
                    (instruction && (instruction.includes('地铁') || instruction.includes('MTR')))) {
                    

                    
                    // 尝试从地铁路段数据中提取信息，但去除"乘坐X站"部分
                    var formattedInstruction = formatSubwayInstruction(segment);
                    if (formattedInstruction) {
                        // 移除"乘坐X站"部分，因为我们要用可折叠的站点列表替代
                        instruction = formattedInstruction.replace(/，乘坐\d+站/, '');

                    }
                    
                    // 生成地铁站点列表
                    subwayStopsHtml = renderSubwayStops(segment, segments.length, index);
                }
                
                var stepHtml = `
                    <div class="step-item">
                        <div class="step-icon ${iconClass}">${iconText}</div>
                        <div class="step-content">
                            <div class="step-instruction">${instruction}</div>
                            <div class="step-details">
                                <div>
                                    ${durationInfo} ${distanceInfo}
                                </div>
                                <div>
                                    ${walkLink}
                                </div>
                            </div>
                            ${subwayStopsHtml}
                        </div>
                    </div>
                `;
                

                stepsHtml += stepHtml;
            });
            
            stepsHtml += '</div>';
            return stepsHtml;
        }
        
        // 渲染路线
        function renderRoute(route, index) {
            var transportTypes = getTransportSummary(route.segments);
            var actualCost = getActualCost(route);
            var walkingDistance = getWalkingDistance(route.segments);
            
            // 生成交通方式徽章
            var transportBadges = transportTypes.map(function(type) {
                var badgeClass = type === '步行' ? 'walk' : (type === '地铁' ? 'metro' : 'bus');
                return `<span class="transport-badge ${badgeClass}">${type}</span>`;
            }).join('');
            
            // 根据是否有费用信息来决定显示内容
            var costDisplay = actualCost !== null && actualCost !== undefined ? 
                `<div class="route-cost">¥${actualCost}</div>` : '';
            
            var routeHtml = `
                <div class="route-item" data-route-index="${index}">
                    <div class="route-header" onclick="toggleRoute(${index})">
                        <div class="route-title">
                            <div class="expand-icon" id="expand-icon-${index}"></div>
                            方案 ${index + 1}
                        </div>
                        <div class="route-summary">
                            <div class="route-time">${formatDuration(route.time)}</div>
                            <div class="route-distance">${formatDistance(walkingDistance)}</div>
                            ${costDisplay}
                        </div>
                    </div>
                    <div class="route-steps" id="route-steps-${index}">
                        ${renderSteps(route.segments)}
                    </div>
                </div>
            `;
            return routeHtml;
        }
        
        // 折叠/展开路线
        function toggleRoute(index) {
            var allRouteSteps = document.querySelectorAll('.route-steps');
            var allExpandIcons = document.querySelectorAll('.expand-icon');
            var allRouteHeaders = document.querySelectorAll('.route-header');
            
            // 折叠所有其他路线
            for (var i = 0; i < allRouteSteps.length; i++) {
                if (i !== index) {
                    allRouteSteps[i].classList.remove('expanded');
                    allExpandIcons[i].classList.remove('expanded');
                    allRouteHeaders[i].classList.remove('expanded');
                }
            }
            
            // 切换当前路线
            var currentSteps = document.getElementById('route-steps-' + index);
            var currentIcon = document.getElementById('expand-icon-' + index);
            var currentHeader = currentSteps.previousElementSibling;
            
            if (currentSteps.classList.contains('expanded')) {
                // 如果当前已展开，则折叠
                currentSteps.classList.remove('expanded');
                currentIcon.classList.remove('expanded');
                currentHeader.classList.remove('expanded');
            } else {
                // 展开当前路线
                currentSteps.classList.add('expanded');
                currentIcon.classList.add('expanded');
                currentHeader.classList.add('expanded');
            }
        }
        
        // 显示错误信息
        function showError(message) {
            var errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(function() {
                errorDiv.classList.add('hidden');
            }, 5000);
        }
        
        // 搜索路线
        function searchRoute() {
            var city = getCurrentCity();
            var startKeyword = document.getElementById('startinput').value.trim();
            var endKeyword = document.getElementById('endinput').value.trim();
            
            // 保存起终点到本地存储
            saveStartEnd();
            
            if (!city) {
                showError('请输入城市名称');
                return;
            }
            
            if (!startKeyword) {
                showError('请输入起点');
                return;
            }
            
            if (!endKeyword) {
                showError('请输入终点');
                return;
            }
            
            // 显示加载状态
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('search-btn').disabled = true;
            
            // 搜索起点和终点坐标
            var startSearchPromise = new Promise(function(resolve) {
                if (startLocation) {
                    resolve(startLocation);
                } else {
                    searchLocation(startKeyword, city, true, resolve);
                }
            });
            
            var endSearchPromise = new Promise(function(resolve) {
                if (endLocation) {
                    resolve(endLocation);
                } else {
                    searchLocation(endKeyword, city, false, resolve);
                }
            });
            
            Promise.all([startSearchPromise, endSearchPromise]).then(function(locations) {
                var startLoc = locations[0];
                var endLoc = locations[1];
                
                if (!startLoc || !endLoc) {
                    throw new Error('无法找到起点或终点的位置信息');
                }
                
                // 获取出发时间
                var departureTime = getDepartureTimestamp();
                
                // 创建公交路线规划服务
                var transfer = new AMap.Transfer({
                    policy: getPolicyValue(),
                    city: city,
                    nightflag: true
                });
                
                // 执行路线搜索
                // 注意：高德地图API的transfer.search方法对于时间参数的处理比较特殊
                // 先使用标准的搜索方式，时间功能暂时注释掉以避免错误
                transfer.search(startLoc, endLoc, function(status, result) {
                    handleTransferResult(status, result);
                });
                
                // 如果需要支持出发时间，需要使用更复杂的方式，暂时注释掉
                /*
                if (departureTime) {
                    // 使用带时间的搜索（高德API可能需要不同的参数格式）

                }
                */
                
            }).catch(function(error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('search-btn').disabled = false;
                showError(error.message);

            });
        }
        
        // 处理路线搜索结果
        function handleTransferResult(status, result) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('search-btn').disabled = false;
            
            if (status === 'complete' && result.plans && result.plans.length > 0) {

                
                var routesHtml = '';
                result.plans.forEach(function(plan, index) {
                    routesHtml += renderRoute(plan, index);
                });
                
                document.getElementById('routes-container').innerHTML = routesHtml;
                document.getElementById('result').classList.remove('hidden');
                
            } else {
                showError('路线规划失败：' + (result.info || '未知错误'));

            }
        }
        
        // 绑定搜索按钮事件
        document.getElementById('search-btn').addEventListener('click', searchRoute);
        
        // 移除重复的回车事件处理，因为输入提示功能已经处理了回车键
        
        document.getElementById('cityinput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveCity(this.value);
                document.getElementById('startinput').focus();
            }
        });
        
        // 更新搜索服务的城市
        function updateSearchCity() {
            var city = getCurrentCity();
            if (city !== currentCity) {
                currentCity = city;
                setupAutocomplete();
            }
        }
    </script>
</body>
</html>