<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>ÂÖ¨‰∫§Ë∑ØÁ∫øËßÑÂàí</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 0px;
            align-items: flex-end;
        }
        
        .swap-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 0;
            height: 155px;
        }
        
        .swap-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #4ec9b0;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
            flex-shrink: 0;
            line-height: 1;
            padding: 0;
        }
        
        .swap-btn:hover {
            background-color: #3ba996;
            transform: scale(1.05);
        }
        
        .swap-btn:active {
            transform: scale(0.95);
        }
        
        .input-item {
            flex: 1;
            margin-bottom: 15px;
        }
        
        .input-item-wide {
            flex: 1;
            margin-bottom: 15px;
        }
        
        .input-item-prepend {
            margin-bottom: 8px;
        }
        
        .input-item-text {
            font-weight: bold;
            color: #cccccc;
            font-size: 14px;
        }
        
        #cityinput, #startinput, #endinput, #departuretime, #policy-select {
            width: 100%;
            padding: 12px;
            padding-right: 70px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #3c3c3c;
            color: #d4d4d4;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        #policy-select {
            padding-right: 12px;
            cursor: pointer;
        }
        
        #cityinput:focus, #startinput:focus, #endinput:focus, #departuretime:focus, #policy-select:focus {
            outline: none;
            border-color: #0078d4;
            background-color: #404040;
        }
        
        #cityinput::placeholder, #startinput::placeholder, #endinput::placeholder, #departuretime::placeholder {
            color: #858585;
        }
        
        .search-btn {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            transition: background-color 0.2s;
            margin-top: 20px;
            width: 100%;
        }
        
        .search-btn:hover {
            background-color: #106ebe;
        }
        
        .search-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .result-container {
            margin-top: 20px;
            padding: 15px;
            border-left: 4px solid #0078d4;
            background-color: #2d2d30;
            border-radius: 4px;
        }
        
        .result-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #cccccc;
            font-size: 16px;
        }
        
        .route-item {
            margin-bottom: 15px;
            background-color: #252526;
            border-radius: 4px;
            border: 1px solid #3e3e42;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .route-header:hover {
            background-color: #2d2d30;
        }
        
        .route-header.expanded {
            border-bottom: 1px solid #3e3e42;
        }
        
        .route-title {
            color: #569cd6;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .expand-icon {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #569cd6;
            transition: transform 0.3s ease;
            transform-origin: center;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .route-summary {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .route-time, .route-cost, .route-distance {
            color: #ce9178;
            font-size: 14px;
        }
        
        .route-transport {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .transport-badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .transport-badge.walk {
            background-color: #4ec9b0;
        }
        
        .transport-badge.bus {
            background-color: #dcdcaa;
        }
        
        .transport-badge.metro {
            background-color: #c586c0;
        }
        
        .route-steps {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .route-steps.expanded {
            max-height: 2000px;
        }
        
        .route-steps-content {
            padding: 0 15px 15px 15px;
        }
        
        .step-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 8px;
            background-color: #1e1e1e;
            border-radius: 4px;
        }
        
        .step-icon {
            width: 30px;
            height: 30px;
            background-color: #0078d4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .step-icon.walk {
            background-color: #4ec9b0;
        }
        
        .step-icon.bus {
            background-color: #dcdcaa;
        }
        
        .step-icon.metro {
            background-color: #c586c0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-instruction {
            color: #d4d4d4;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .step-details {
            color: #858585;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
        }
        
        .subway-stops {
            margin-top: 8px;
            padding-left: 12px;
            font-size: 12px;
            color: #9cdcfe;
        }
        
        .subway-stops-header {
            cursor: pointer;
            color: #569cd6;
            font-size: 12px;
            margin-bottom: 4px;
            user-select: none;
            transition: color 0.2s;
        }
        
        .subway-stops-header:hover {
            color: #4a9eff;
            text-decoration: underline;
        }
        
        .bus-stops {
            margin-top: 8px;
            padding-left: 12px;
            font-size: 12px;
            color: #9cdcfe;
        }
        
        .bus-stops-header {
            cursor: pointer;
            color: #dcdcaa;
            font-size: 12px;
            margin-bottom: 4px;
            user-select: none;
            transition: color 0.2s;
        }
        
        .bus-stops-header:hover {
            color: #b8b869;
            text-decoration: underline;
        }
        
        .subway-stops-list {
            display: none;
            line-height: 1.4;
            margin-left: 8px;
        }
        
        .subway-stops-list.expanded {
            display: block;
        }
        
        .subway-stop-item {
            padding: 2px 0;
            border-left: 2px solid #569cd6;
            padding-left: 8px;
            margin-bottom: 2px;
        }
        
        .subway-stop-item:last-child {
            border-left-color: #c586c0;
        }
        
        .om-walk-link {
            color: #569cd6;
            text-decoration: none;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: #1e1e1e;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        .om-walk-link:hover {
            background-color: #3c3c3c;
            text-decoration: underline;
        }
        
        .autocomplete-container {
            position: relative;
        }
        
        .clear-btn {
            position: absolute;
            right: 44px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: none;
            background: #666;
            color: #d4d4d4;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, color 0.2s;
            z-index: 10;
            line-height: 1;
            padding: 0;
        }
        
        .clear-btn:hover {
            background: #0078d4;
            color: white;
        }
        
        .clear-btn:active {
            transform: translateY(-50%) scale(0.9);
        }
        
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3C3C3C;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
            z-index: 1000;
            line-height: 1;
            padding: 0;
        }
        
        .settings-btn:hover {
            background-color: #3C3C3C;
            transform: scale(1.05);
        }
        
        .settings-btn:active {
            transform: scale(0.95);
        }
        
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .settings-modal.show {
            display: flex;
        }
        
        .settings-card {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 80%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .settings-title {
            color: #cccccc;
            font-size: 20px;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #858585;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        
        .close-btn:hover {
            color: #d4d4d4;
        }
        
        .setting-item {
            margin-bottom: 20px;
        }
        
        .setting-label {
            display: block;
            color: #cccccc;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .setting-input-group {
            position: relative;
        }
        
        .setting-input {
            width: 100%;
            padding: 12px;
            padding-right: 35px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #3c3c3c;
            color: #d4d4d4;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #0078d4;
            background-color: #404040;
        }
        
        .setting-input::placeholder {
            color: #858585;
        }
        
        .save-settings-btn {
            background-color: #3C3C3C;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: 20px;
        }
        
        .save-settings-btn:hover {
            background-color: #3C3C3C;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            right: 0;
            top: 0;
            width: 35px;
            height: 100%;
            border: none;
            background: #666;
            color: #d4d4d4;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            z-index: 10;
            padding: 0;
        }
        
        .autocomplete-dropdown:hover {
            background: #0078d4;
            color: white;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 10px 15px;
            color: #d4d4d4;
            cursor: pointer;
            border-bottom: 1px solid #3e3e42;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover {
            background-color: #3c3c3c;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item.header {
            color: #858585;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 8px 15px;
            cursor: default;
        }
        
        .dropdown-item.header:hover {
            background-color: transparent;
        }
        
        .amap-sug-result {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #252526;
            border: 1px solid #3e3e42;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 0 0 4px 4px;
        }
        
        .amap-sug-result .auto-item {
            padding: 8px 12px;
            color: #d4d4d4;
            cursor: pointer;
            border-bottom: 1px solid #3e3e42;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            font-size: 13px;
        }
        
        .amap-sug-result .auto-item:hover {
            background-color: #3c3c3c;
        }
        
        .amap-sug-result .auto-item:last-child {
            border-bottom: none;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #cccccc;
            padding: 20px;
        }
        
        .error {
            color: #f48771;
            background-color: #2d1b1b;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #8c2d2d;
        }
        

        

    </style>
</head>
<body>
    <!-- ËÆæÁΩÆÊåâÈíÆ -->
    <button class="settings-btn" onclick="openSettings()" title="ËÆæÁΩÆÂ∏∏Áî®Âú∞ÂùÄ">=</button>
    
    <!-- ËÆæÁΩÆÂºπÁ™ó -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-card">
            <div class="settings-header">
                <h2 class="settings-title">ËÆæÁΩÆÂ∏∏Áî®Âú∞ÂùÄ</h2>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">ÂÆ∂Â∫≠Âú∞ÂùÄ</label>
                <div class="setting-input-group">
                    <input id="home-input" type="text" class="setting-input" placeholder="ËæìÂÖ•ÂÆ∂Â∫≠Âú∞ÂùÄ">
                    <button class="clear-btn" onclick="clearSettingInput('home-input')" title="Ê∏ÖÈô§ÂÜÖÂÆπ" style="right: 10px;">√ó</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">ÂÖ¨Âè∏Âú∞ÂùÄ</label>
                <div class="setting-input-group">
                    <input id="company-input" type="text" class="setting-input" placeholder="ËæìÂÖ•ÂÖ¨Âè∏Âú∞ÂùÄ">
                    <button class="clear-btn" onclick="clearSettingInput('company-input')" title="Ê∏ÖÈô§ÂÜÖÂÆπ" style="right: 10px;">√ó</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">Êî∂ËóèÂú∞ÂùÄ</label>
                <div class="setting-input-group">
                    <input id="favorite-input" type="text" class="setting-input" placeholder="ËæìÂÖ•Êî∂ËóèÂú∞ÂùÄ">
                    <button class="clear-btn" onclick="clearSettingInput('favorite-input')" title="Ê∏ÖÈô§ÂÜÖÂÆπ" style="right: 10px;">√ó</button>
                </div>
            </div>
            
            <button class="save-settings-btn" onclick="saveSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>

    <div class="container">
        <h1 style="text-align: center; color: #cccccc; margin-bottom: 30px; font-weight: 300; font-size: 24px;">ÂÖ¨‰∫§Ë∑ØÁ∫øËßÑÂàí</h1>
        
        <div class="input-group">
            <div class="input-item">
                <div class="input-item-prepend">
                    <span class="input-item-text">ÂüéÂ∏Ç</span>
                </div>
                <input id='cityinput' type="text" placeholder="ËæìÂÖ•ÂüéÂ∏ÇÂêçÁß∞" style="padding-right: 12px;">
            </div>
            <div class="input-item">
                <div class="input-item-prepend">
                    <span class="input-item-text">Âá∫ÂèëÊó∂Èó¥</span>
                </div>
                <input id='departuretime' type="text" placeholder="‰æãÂ¶ÇÔºö8„ÄÅ14:30„ÄÅ18:30" style="padding-right: 12px;">
            </div>
            <div class="input-item">
                <div class="input-item-prepend">
                    <span class="input-item-text">Ë∑ØÁ∫øÈÄâÊã©‰æùÊçÆ</span>
                </div>
                <select id="policy-select">
                    <option value="LEAST_TIME">ÊúÄÂø´Êç∑</option>
                    <option value="LEAST_SWAP">ÊúÄÂ∞ëÊç¢‰πò</option>
                    <option value="LEAST_WALK">ÊúÄÂ∞ëÊ≠•Ë°å</option>
                    <option value="MOST_COMFORT">ÊúÄËàíÈÄÇ</option>
                    <option value="NO_SUBWAY">‰∏ç‰πòÂú∞ÈìÅ</option>
                </select>
            </div>
        </div>
        <div class="input-group">
            <div class="input-box" style="width: 90%;">
                <div class="input-group">
                    <div class="input-item-wide">
                        <div class="input-item-prepend">
                            <span class="input-item-text">Ëµ∑ÁÇπ</span>
                        </div>
                        <div class="autocomplete-container">
                            <input id='startinput' type="text" placeholder="ËæìÂÖ•Ëµ∑ÁÇπÂêçÁß∞">
                            <button class="clear-btn" onclick="clearInput('startinput')" title="Ê∏ÖÈô§ÂÜÖÂÆπ">√ó</button>
                            <button class="autocomplete-dropdown" onclick="toggleDropdown('start')" title="ÂéÜÂè≤ËÆ∞ÂΩïÂíåÂ∏∏Áî®Âú∞ÂùÄ">‚ñº</button>
                            <div id="start-dropdown" class="dropdown-menu">
                                <div class="dropdown-item header">ÂéÜÂè≤ËÆ∞ÂΩï</div>
                                <div id="start-history"></div>
                                <div class="dropdown-item header">Â∏∏Áî®Âú∞ÂùÄ</div>
                                <div class="dropdown-item" onclick="selectFromDropdown('start', 'home')">üè† ÂÆ∂</div>
                                <div class="dropdown-item" onclick="selectFromDropdown('start', 'company')">üè¢ ÂÖ¨Âè∏</div>
                                <div class="dropdown-item" onclick="selectFromDropdown('start', 'favorite')">‚≠ê Êî∂Ëóè</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-item-wide">
                        <div class="input-item-prepend">
                            <span class="input-item-text">ÁªàÁÇπ</span>
                        </div>
                        <div class="autocomplete-container">
                            <input id='endinput' type="text" placeholder="ËæìÂÖ•ÁªàÁÇπÂêçÁß∞">
                            <button class="clear-btn" onclick="clearInput('endinput')" title="Ê∏ÖÈô§ÂÜÖÂÆπ">√ó</button>
                            <button class="autocomplete-dropdown" onclick="toggleDropdown('end')" title="ÂéÜÂè≤ËÆ∞ÂΩïÂíåÂ∏∏Áî®Âú∞ÂùÄ">‚ñº</button>
                            <div id="end-dropdown" class="dropdown-menu">
                                <div class="dropdown-item header">ÂéÜÂè≤ËÆ∞ÂΩï</div>
                                <div id="end-history"></div>
                                <div class="dropdown-item header">Â∏∏Áî®Âú∞ÂùÄ</div>
                                <div class="dropdown-item" onclick="selectFromDropdown('end', 'home')">üè† ÂÆ∂</div>
                                <div class="dropdown-item" onclick="selectFromDropdown('end', 'company')">üè¢ ÂÖ¨Âè∏</div>
                                <div class="dropdown-item" onclick="selectFromDropdown('end', 'favorite')">‚≠ê Êî∂Ëóè</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="swap-container" style="width: 10%;">
                <button id="swap-btn" class="swap-btn" onclick="swapStartEnd()" title="‰∫§Êç¢Ëµ∑ÁªàÁÇπ">‚áµ</button>
            </div>
        </div>
        <button id="search-btn" class="search-btn">ËßÑÂàíË∑ØÁ∫ø</button>
        
        <div id="loading" class="loading hidden">
            Ê≠£Âú®ËßÑÂàíË∑ØÁ∫ø...
        </div>
        
        <div id="error" class="error hidden"></div>
        
        <div id="result" class="result-container hidden">
            <div class="result-title">Ë∑ØÁ∫øÊñπÊ°à</div>
            <div id="routes-container"></div>
        </div>
    </div>

    <!-- ÂºïÂÖ•È´òÂæ∑Âú∞ÂõæAPI -->
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=‰Ω†ÁöÑÈ´òÂæ∑apiKEY&plugin=AMap.Transfer,AMap.PlaceSearch"></script>
    
    <!-- ÂùêÊ†áËΩ¨Êç¢ÂáΩÊï∞ -->
    <script type="text/javascript">
        // eviltransform.js - ÂùêÊ†áËΩ¨Êç¢Â∫ì
        // Êù•Ê∫êÔºöhttps://github.com/googollee/eviltransform/blob/master/javascript/transform.js
        
        function outOfChina(lat, lng) {
            if (lng < 72.004 || lng > 137.8347)
                return true;
            if (lat < 0.8293 || lat > 55.8271)
                return true;
            return false;
        }
        var earthR = 6378137.0;
        function transform(x, y) {
            var xy = x * y;
            var absX = Math.sqrt(Math.abs(x));
            var xPi = x * Math.PI;
            var yPi = y * Math.PI;
            var d = 20.0*Math.sin(6.0*xPi) + 20.0*Math.sin(2.0*xPi);

            var lat = d;
            var lng = d;

            lat += 20.0*Math.sin(yPi) + 40.0*Math.sin(yPi/3.0);
            lng += 20.0*Math.sin(xPi) + 40.0*Math.sin(xPi/3.0);

            lat += 160.0*Math.sin(yPi/12.0) + 320*Math.sin(yPi/30.0);
            lng += 150.0*Math.sin(xPi/12.0) + 300.0*Math.sin(xPi/30.0);

            lat *= 2.0 / 3.0;
            lng *= 2.0 / 3.0;

            lat += -100.0 + 2.0*x + 3.0*y + 0.2*y*y + 0.1*xy + 0.2*absX;
            lng += 300.0 + x + 2.0*y + 0.1*x*x + 0.1*xy + 0.1*absX;

            return {lat: lat, lng: lng}
        }
        function delta(lat, lng) {
            var ee = 0.00669342162296594323;
            var d = transform(lng-105.0, lat-35.0);
            var radLat = lat / 180.0 * Math.PI;
            var magic = Math.sin(radLat);
            magic = 1 - ee*magic*magic;
            var sqrtMagic = Math.sqrt(magic);
            d.lat = (d.lat * 180.0) / ((earthR * (1 - ee)) / (magic * sqrtMagic) * Math.PI);
            d.lng = (d.lng * 180.0) / (earthR / sqrtMagic * Math.cos(radLat) * Math.PI);
            return d;
        }
        
        function gcj2wgs_exact(gcjLat, gcjLng) {
            var newLat = gcjLat, newLng = gcjLng;
            var oldLat = newLat, oldLng = newLng;
            var threshold = 1e-6; 

            for (var i = 0; i < 50; i++) {
                oldLat = newLat;
                oldLng = newLng;
                var d = delta(newLat, newLng);
                newLat = gcjLat - d.lat;
                newLng = gcjLng - d.lng;
                if (Math.max(Math.abs(oldLat - newLat), Math.abs(oldLng - newLng)) < threshold) {
                    break;
                }
            }
            return {lat: newLat, lng: newLng};
        }
    </script>
    
    <script type="text/javascript">
        // ÂÖ®Â±ÄÂèòÈáè
        var startLocation = null;
        var endLocation = null;
        var currentCity = '';
        var startAuto = null;
        var endAuto = null;
        var startPlaceSearch = null;
        var endPlaceSearch = null;
        
        // Âä†ËΩΩÊó∂ÊÅ¢Â§ç‰∏ä‰∏ÄÊ¨°ÁöÑÂüéÂ∏ÇÈÄâÊã©
        window.addEventListener('DOMContentLoaded', function() {
            var savedCity = localStorage.getItem('selectedCity');
            if (savedCity) {
                document.getElementById('cityinput').value = savedCity;
                currentCity = savedCity;
            }
            
            // ‰∏çÊÅ¢Â§ç‰∏ä‰∏ÄÊ¨°ÁöÑËµ∑ÁÇπÂíåÁªàÁÇπÔºå‰øùÊåÅÁ©∫ÁôΩ
            
            // ËÆæÁΩÆÈªòËÆ§Âá∫ÂèëÊó∂Èó¥‰∏∫ÂΩìÂâçÊó∂Èó¥
            setDefaultDepartureTime();
            
            // ËÆæÁΩÆËá™Âä®ÂÆåÊàê
            setupAutocomplete();
        });
        
        // ËÆæÁΩÆÈªòËÆ§Âá∫ÂèëÊó∂Èó¥
        function setDefaultDepartureTime() {
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            var timeString = hours + ':' + (minutes < 10 ? '0' + minutes : minutes);
            document.getElementById('departuretime').value = timeString;
        }
        
        // Êô∫ËÉΩËΩ¨Êç¢Êó∂Èó¥Ê†ºÂºè
        function parseTimeInput(input) {
            input = input.trim();
            if (!input) return null;
            
            // Â§ÑÁêÜÁ∫ØÊï∞Â≠óÔºàÂ¶ÇÔºö8„ÄÅ15„ÄÅ23Ôºâ
            if (/^\d+$/.test(input)) {
                var hour = parseInt(input);
                if (hour >= 0 && hour <= 23) {
                    return hour + ':00';
                }
            }
            
            // Â§ÑÁêÜÂ∞èÊó∂:ÂàÜÈíüÊ†ºÂºèÔºàÂ¶ÇÔºö8:30„ÄÅ14:30„ÄÅ8:3Ôºâ
            if (/^\d{1,2}:\d{1,2}$/.test(input)) {
                var parts = input.split(':');
                var hour = parseInt(parts[0]);
                var minute = parseInt(parts[1]);
                
                if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                    return hour + ':' + (minute < 10 ? '0' + minute : minute);
                }
            }
            
            // Â§ÑÁêÜÂ∏¶ÂÜíÂè∑ÁöÑ‰∏â‰ΩçÊï∞ÔºàÂ¶ÇÔºö8:3 ËΩ¨Êç¢‰∏∫ 8:30Ôºâ
            if (/^\d{1,2}:\d$/.test(input)) {
                var parts = input.split(':');
                var hour = parseInt(parts[0]);
                var minute = parseInt(parts[1]) * 10; // Â∞Ü‰∏™‰ΩçÊï∞ËΩ¨Êç¢‰∏∫Êï¥ÂçÅÂàÜÈíü
                
                if (hour >= 0 && hour <= 23 && minute <= 50) {
                    return hour + ':' + (minute < 10 ? '0' + minute : minute);
                }
            }
            
            return null; // Êó†ÊïàÊ†ºÂºè
        }
        
        // Ëé∑ÂèñÂá∫ÂèëÊó∂Èó¥Êà≥ÔºàÁî®‰∫éAPIË∞ÉÁî®Ôºâ
        function getDepartureTimestamp() {
            var timeInput = document.getElementById('departuretime').value;
            var parsedTime = parseTimeInput(timeInput);
            
            if (!parsedTime) {
                return null; // ‰ΩøÁî®APIÈªòËÆ§ÔºàÂΩìÂâçÊó∂Èó¥Ôºâ
            }
            
            var now = new Date();
            var parts = parsedTime.split(':');
            var departureDate = new Date();
            departureDate.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);
            
            // Â¶ÇÊûúËÆæÂÆöÁöÑÊó∂Èó¥Â∑≤ÁªèËøáÂéªÔºåËÆæÁΩÆ‰∏∫ÊòéÂ§©
            if (departureDate.getTime() < now.getTime()) {
                departureDate.setDate(departureDate.getDate() + 1);
            }
            
            return Math.floor(departureDate.getTime() / 1000); // ËΩ¨Êç¢‰∏∫ÁßíÊó∂Èó¥Êà≥
        }
        
        // ËÆæÁΩÆËá™Âä®ÂÆåÊàê
        function setupAutocomplete() {
            var city = getCurrentCity();
            
            // Âú∞ÁÇπÊêúÁ¥¢ÊúçÂä°
            startPlaceSearch = new AMap.PlaceSearch({
                city: city,
                pageSize: 5
            });
            
            endPlaceSearch = new AMap.PlaceSearch({
                city: city,
                pageSize: 5
            });
            
            // ËÆæÁΩÆËæìÂÖ•ÊèêÁ§∫
            setupInputSuggestion('startinput', startPlaceSearch, function(location) {
                startLocation = location;
            });
            
            setupInputSuggestion('endinput', endPlaceSearch, function(location) {
                endLocation = location;
            });
        }
        
        // ËÆæÁΩÆËæìÂÖ•ÊèêÁ§∫ÂäüËÉΩ
        function setupInputSuggestion(inputId, placeSearch, onLocationSet) {
            var inputElement = document.getElementById(inputId);
            var suggestionDiv = null;
            var currentSuggestions = [];
            var selectedIndex = -1;
            
            // ÂàõÂª∫Âª∫ËÆÆ‰∏ãÊãâÊ°Ü
            function createSuggestionDiv() {
                if (suggestionDiv) {
                    suggestionDiv.remove();
                }
                
                suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'amap-sug-result';
                suggestionDiv.style.display = 'none';
                inputElement.parentNode.appendChild(suggestionDiv);
            }
            
            // ÊòæÁ§∫Âª∫ËÆÆ
            function showSuggestions(suggestions) {
                createSuggestionDiv();
                currentSuggestions = suggestions;
                selectedIndex = -1;
                
                suggestionDiv.innerHTML = '';
                suggestions.forEach(function(item, index) {
                    var div = document.createElement('div');
                    div.className = 'auto-item';
                    div.textContent = item.name + ' - ' + item.address;
                    div.addEventListener('click', function() {
                        inputElement.value = item.name + ' - ' + item.address;
                        if (item.location) {
                            onLocationSet(item.location);

                        }
                        hideSuggestions();
                    });
                    suggestionDiv.appendChild(div);
                });
                
                suggestionDiv.style.display = suggestions.length > 0 ? 'block' : 'none';
            }
            
            // ÈöêËóèÂª∫ËÆÆ
            function hideSuggestions() {
                if (suggestionDiv) {
                    suggestionDiv.style.display = 'none';
                }
            }
            
            // ÊêúÁ¥¢Âª∫ËÆÆ
            function searchSuggestions(keyword) {
                if (keyword.length < 2) {
                    hideSuggestions();
                    return;
                }
                
                placeSearch.search(keyword, function(status, result) {
                    if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                        showSuggestions(result.poiList.pois);
                    } else {
                        hideSuggestions();
                    }
                });
            }
            
            // ÈîÆÁõò‰∫ã‰ª∂Â§ÑÁêÜ
            inputElement.addEventListener('input', function(e) {
                var keyword = e.target.value.trim();
                searchSuggestions(keyword);
            });
            
            inputElement.addEventListener('keydown', function(e) {
                if (!currentSuggestions.length) return;
                
                var items = suggestionDiv.querySelectorAll('.auto-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0) {
                        items[selectedIndex].click();
                    } else {
                        hideSuggestions();
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            function updateSelection(items) {
                items.forEach(function(item, index) {
                    if (index === selectedIndex) {
                        item.style.backgroundColor = '#3c3c3c';
                    } else {
                        item.style.backgroundColor = 'transparent';
                    }
                });
            }
            
            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÂª∫ËÆÆ
            document.addEventListener('click', function(e) {
                if (!inputElement.contains(e.target) && (!suggestionDiv || !suggestionDiv.contains(e.target))) {
                    hideSuggestions();
                }
            });
        }
        
        // ‰øùÂ≠òÂüéÂ∏ÇÈÄâÊã©
        function saveCity(city) {
            if (city && city.trim()) {
                localStorage.setItem('selectedCity', city.trim());
                currentCity = city.trim();
                // ÈáçÊñ∞ËÆæÁΩÆËá™Âä®ÂÆåÊàêÁöÑÂüéÂ∏Ç
                setupAutocomplete();
                
                // Â¶ÇÊûúËÆæÁΩÆÂºπÁ™óÊòØÊâìÂºÄÁöÑÔºå‰πüË¶ÅÊõ¥Êñ∞ËÆæÁΩÆÈ°µÈù¢ÁöÑËá™Âä®ÂÆåÊàê
                var modal = document.getElementById('settings-modal');
                if (modal && modal.classList.contains('show')) {
                    setupSettingsAutocomplete();
                }
            }
        }
        
        // ‰∏çÂÜç‰øùÂ≠òËµ∑ÁÇπÂíåÁªàÁÇπÂà∞localStorage
        function saveStartEnd() {
            // Á©∫ÂáΩÊï∞Ôºå‰∏çÂÜç‰øùÂ≠òËµ∑ÁÇπÂíåÁªàÁÇπ
        }
        
        // Ê∏ÖÈô§ËæìÂÖ•Ê°ÜÂÜÖÂÆπ
        function clearInput(inputId) {
            var input = document.getElementById(inputId);
            input.value = '';
            
            // Ê∏ÖÈô§ÂØπÂ∫îÁöÑ‰ΩçÁΩÆÂèòÈáè
            if (inputId === 'startinput') {
                startLocation = null;
            } else if (inputId === 'endinput') {
                endLocation = null;
            }
            
            // ÈöêËóèËá™Âä®ÂÆåÊàêÂª∫ËÆÆ
            hideAllSuggestions();
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveStartEnd();
            
            // ËÆ©ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπ
            input.focus();
        }
        
        // ÈöêËóèÊâÄÊúâÂª∫ËÆÆ‰∏ãÊãâÊ°Ü
        function hideAllSuggestions() {
            var suggestions = document.querySelectorAll('.amap-sug-result');
            suggestions.forEach(function(suggestion) {
                suggestion.style.display = 'none';
            });
        }
        
        // ÊâìÂºÄËÆæÁΩÆÂºπÁ™ó
        function openSettings() {
            var modal = document.getElementById('settings-modal');
            modal.classList.add('show');
            
            // Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑËÆæÁΩÆ
            loadSettings();
            
            // ËÆæÁΩÆËá™Âä®ÂÆåÊàêÂäüËÉΩ
            setupSettingsAutocomplete();
        }
        
        // ÂÖ≥Èó≠ËÆæÁΩÆÂºπÁ™ó
        function closeSettings() {
            var modal = document.getElementById('settings-modal');
            modal.classList.remove('show');
        }
        
        // Ê∏ÖÈô§ËÆæÁΩÆËæìÂÖ•Ê°Ü
        function clearSettingInput(inputId) {
            var input = document.getElementById(inputId);
            input.value = '';
            input.focus();
        }
        
        // Âä†ËΩΩËÆæÁΩÆ
        function loadSettings() {
            var homeAddress = localStorage.getItem('homeAddress');
            var companyAddress = localStorage.getItem('companyAddress');
            var favoriteAddress = localStorage.getItem('favoriteAddress');
            
            if (homeAddress) {
                document.getElementById('home-input').value = homeAddress;
            }
            if (companyAddress) {
                document.getElementById('company-input').value = companyAddress;
            }
            if (favoriteAddress) {
                document.getElementById('favorite-input').value = favoriteAddress;
            }
        }
        
        // ‰øùÂ≠òËÆæÁΩÆ
        function saveSettings() {
            var homeAddress = document.getElementById('home-input').value.trim();
            var companyAddress = document.getElementById('company-input').value.trim();
            var favoriteAddress = document.getElementById('favorite-input').value.trim();
            
            if (homeAddress) {
                localStorage.setItem('homeAddress', homeAddress);
            } else {
                localStorage.removeItem('homeAddress');
            }
            
            if (companyAddress) {
                localStorage.setItem('companyAddress', companyAddress);
            } else {
                localStorage.removeItem('companyAddress');
            }
            
            if (favoriteAddress) {
                localStorage.setItem('favoriteAddress', favoriteAddress);
            } else {
                localStorage.removeItem('favoriteAddress');
            }
            
            // ÂÖ≥Èó≠ÂºπÁ™ó
            closeSettings();
        }
        
        // ÂàáÊç¢‰∏ãÊãâËèúÂçïÊòæÁ§∫Áä∂ÊÄÅ
        function toggleDropdown(type) {
            var dropdownId = type + '-dropdown';
            var dropdown = document.getElementById(dropdownId);
            
            // ÂÖ≥Èó≠ÊâÄÊúâÂÖ∂‰ªñ‰∏ãÊãâËèúÂçï
            ['start-dropdown', 'end-dropdown'].forEach(function(id) {
                if (id !== dropdownId) {
                    document.getElementById(id).classList.remove('show');
                }
            });
            
            // ÂàáÊç¢ÂΩìÂâç‰∏ãÊãâËèúÂçï
            dropdown.classList.toggle('show');
            
            // Â¶ÇÊûúÊòØÊòæÁ§∫Áä∂ÊÄÅÔºåÂä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
            if (dropdown.classList.contains('show')) {
                loadSearchHistory(type);
            }
        }
        
        // ‰ªé‰∏ãÊãâËèúÂçïÈÄâÊã©Âú∞ÂùÄ
        function selectFromDropdown(type, itemType) {
            var address = '';
            var addressName = '';
            
            switch(itemType) {
                case 'home':
                    address = localStorage.getItem('homeAddress');
                    addressName = 'ÂÆ∂';
                    break;
                case 'company':
                    address = localStorage.getItem('companyAddress');
                    addressName = 'ÂÖ¨Âè∏';
                    break;
                case 'favorite':
                    address = localStorage.getItem('favoriteAddress');
                    addressName = 'Êî∂Ëóè';
                    break;
            }
            
            if (address) {
                document.getElementById(type + 'input').value = address;
                // Ëß¶ÂèëÂú∞ÁÇπÊêúÁ¥¢‰ª•Ëé∑ÂèñÂùêÊ†á
                searchLocationForSetPoint(address, type);
                saveStartEnd();
                
                // ‰∏çÊ∑ªÂä†Â∏∏Áî®Âú∞ÂùÄÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                // addToSearchHistory(address, addressName);
                
                // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
                document.getElementById(type + '-dropdown').classList.remove('show');
            } else {
                showMessage('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠Ê∑ªÂä†' + addressName + 'Âú∞ÂùÄ');
            }
        }
        
        // Âä†ËΩΩÊêúÁ¥¢ÂéÜÂè≤ËÆ∞ÂΩï
        function loadSearchHistory(type) {
            var historyKey = type + 'History';
            var history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            var historyContainer = document.getElementById(type + '-history');
            
            historyContainer.innerHTML = '';
            
            if (history.length === 0) {
                var emptyItem = document.createElement('div');
                emptyItem.className = 'dropdown-item';
                emptyItem.textContent = 'ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï';
                emptyItem.style.cursor = 'default';
                emptyItem.style.color = '#858585';
                historyContainer.appendChild(emptyItem);
            } else {
                history.forEach(function(item, index) {
                    var historyItem = document.createElement('div');
                    historyItem.className = 'dropdown-item';
                    historyItem.textContent = item.name;
                    historyItem.onclick = function() {
                        selectHistoryItem(type, item);
                    };
                    historyContainer.appendChild(historyItem);
                });
            }
        }
        
        // ‰ªéÂéÜÂè≤ËÆ∞ÂΩïÈÄâÊã©
        function selectHistoryItem(type, item) {
            document.getElementById(type + 'input').value = item.address;
            // Ëß¶ÂèëÂú∞ÁÇπÊêúÁ¥¢‰ª•Ëé∑ÂèñÂùêÊ†á
            searchLocationForSetPoint(item.address, type);
            saveStartEnd();
            
            // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÔºàÊääÈÄâ‰∏≠ÁöÑÁßªÂà∞ÊúÄÂâçÈù¢Ôºâ
            updateSearchHistory(item.address, item.name, type);
            
            // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
            document.getElementById(type + '-dropdown').classList.remove('show');
        }
        
        // Ê∑ªÂä†Âà∞ÊêúÁ¥¢ÂéÜÂè≤ËÆ∞ÂΩï
        function addToSearchHistory(address, name) {
            ['start', 'end'].forEach(function(type) {
                updateSearchHistory(address, name, type);
            });
        }
        
        // Ê£ÄÊü•ÊòØÂê¶‰∏∫Â∏∏Áî®Âú∞ÂùÄ
        function isCommonAddress(address) {
            var homeAddress = localStorage.getItem('homeAddress');
            var companyAddress = localStorage.getItem('companyAddress');
            var favoriteAddress = localStorage.getItem('favoriteAddress');
            
            return address === homeAddress || address === companyAddress || address === favoriteAddress;
        }
        
        // Êõ¥Êñ∞ÊêúÁ¥¢ÂéÜÂè≤ËÆ∞ÂΩï
        function updateSearchHistory(address, name, type) {
            // ‰∏çÂ∞ÜÂ∏∏Áî®Âú∞ÂùÄÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            if (isCommonAddress(address)) {
                return;
            }
            
            var historyKey = type + 'History';
            var history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÂú∞ÂùÄ
            var existingIndex = history.findIndex(function(item) {
                return item.address === address;
            });
            
            if (existingIndex !== -1) {
                // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÈ°π
                history.splice(existingIndex, 1);
            }
            
            // Ê∑ªÂä†Âà∞ÊúÄÂâçÈù¢
            history.unshift({
                address: address,
                name: name,
                timestamp: Date.now()
            });
            
            // Âè™‰øùÁïôÊúÄËøë5Êù°ËÆ∞ÂΩï
            history = history.slice(0, 5);
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem(historyKey, JSON.stringify(history));
        }
        
        // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', function(e) {
            if (!e.target.matches('.autocomplete-dropdown') && !e.target.closest('.dropdown-menu')) {
                ['start-dropdown', 'end-dropdown'].forEach(function(id) {
                    document.getElementById(id).classList.remove('show');
                });
            }
        });
        
        // ‰∏∫ËÆæÁΩÆÁÇπÊêúÁ¥¢‰ΩçÁΩÆ
        function searchLocationForSetPoint(address, type) {
            var city = getCurrentCity();
            var placeSearch = type === 'start' ? startPlaceSearch : endPlaceSearch;
            
            if (placeSearch) {
                placeSearch.setCity(city);
                placeSearch.search(address, function(status, result) {
                    if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                        var poi = result.poiList.pois[0];
                        if (poi.location) {
                            if (type === 'start') {
                                startLocation = poi.location;
                            } else {
                                endLocation = poi.location;
                            }
                        }
                    }
                });
            }
        }
        
        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(message) {
            // ÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØÊèêÁ§∫
            var messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #2d1b1b;
                color: #f48771;
                padding: 15px 20px;
                border-radius: 4px;
                border: 1px solid #8c2d2d;
                z-index: 3000;
                font-size: 14px;
                font-family: Arial, sans-serif, 'Courier New', monospace;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3ÁßíÂêéÁßªÈô§
            setTimeout(function() {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }
        
        // ËÆæÁΩÆÂºπÁ™óÁöÑËá™Âä®ÂÆåÊàêÂäüËÉΩ
        function setupSettingsAutocomplete() {
            var city = getCurrentCity();
            
            // ÂàõÂª∫Âú∞ÁÇπÊêúÁ¥¢ÊúçÂä°
            if (!window.settingsPlaceSearch) {
                window.settingsPlaceSearch = new AMap.PlaceSearch({
                    city: city,
                    pageSize: 5
                });
            }
            
            // ‰∏∫ÊØè‰∏™ËÆæÁΩÆËæìÂÖ•Ê°ÜËÆæÁΩÆËá™Âä®ÂÆåÊàê
            setupInputSuggestion('home-input', window.settingsPlaceSearch, function(location) {
                // ËÆæÁΩÆÈ°µÈù¢‰∏çÈúÄË¶Å‰øùÂ≠òÂùêÊ†áÔºåÂè™ÈúÄË¶Å‰øùÂ≠òÂú∞ÂùÄÊñáÊú¨
            });
            
            setupInputSuggestion('company-input', window.settingsPlaceSearch, function(location) {
                // ËÆæÁΩÆÈ°µÈù¢‰∏çÈúÄË¶Å‰øùÂ≠òÂùêÊ†áÔºåÂè™ÈúÄË¶Å‰øùÂ≠òÂú∞ÂùÄÊñáÊú¨
            });
            
            setupInputSuggestion('favorite-input', window.settingsPlaceSearch, function(location) {
                // ËÆæÁΩÆÈ°µÈù¢‰∏çÈúÄË¶Å‰øùÂ≠òÂùêÊ†áÔºåÂè™ÈúÄË¶Å‰øùÂ≠òÂú∞ÂùÄÊñáÊú¨
            });
        }
        
        // ÁÇπÂáªÂºπÁ™óËÉåÊôØÂÖ≥Èó≠
        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });
        
        // ‰∫§Êç¢Ëµ∑ÁÇπÂíåÁªàÁÇπ
        function swapStartEnd() {
            var startInput = document.getElementById('startinput');
            var endInput = document.getElementById('endinput');
            var startValue = startInput.value;
            var endValue = endInput.value;
            
            // ‰∫§Êç¢ÂÄº
            startInput.value = endValue;
            endInput.value = startValue;
            
            // ‰∫§Êç¢‰ΩçÁΩÆÂèòÈáè
            var tempLocation = startLocation;
            startLocation = endLocation;
            endLocation = tempLocation;
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveStartEnd();
            
            // ÈáçÊñ∞Ëé∑Âèñ‰ΩçÁΩÆ‰ø°ÊÅØ
            if (startValue) {
                searchLocationForSetPoint(startValue, 'end');
            }
            if (endValue) {
                searchLocationForSetPoint(endValue, 'start');
            }
        }
        
        // Ëé∑ÂèñÂΩìÂâçÂüéÂ∏Ç
        function getCurrentCity() {
            return document.getElementById('cityinput').value.trim() || 'ÂÖ®ÂõΩ';
        }
        
        // ÂüéÂ∏ÇËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÊó∂‰øùÂ≠ò
        document.getElementById('cityinput').addEventListener('blur', function() {
            saveCity(this.value);
        });
        
        // Ëµ∑ÁÇπÂíåÁªàÁÇπËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÊó∂‰øùÂ≠ò
        document.getElementById('startinput').addEventListener('blur', function() {
            saveStartEnd();
        });
        
        document.getElementById('endinput').addEventListener('blur', function() {
            saveStartEnd();
        });
        
        // Âú∞ÁÇπÊêúÁ¥¢ÊúçÂä°
        function searchLocation(keyword, city, isStart, callback) {
            var placeSearch = isStart ? startPlaceSearch : endPlaceSearch;
            placeSearch.setCity(city);
            placeSearch.search(keyword, function(status, result) {
                if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                    var poi = result.poiList.pois[0];
                    if (poi.location) {
                        callback(poi.location);
                    } else {
                        callback(null);
                    }
                } else {
                    callback(null);
                }
            });
        }
        
        // Ëé∑ÂèñÁ≠ñÁï•ÂÄº
        function getPolicyValue() {
            var policySelect = document.getElementById('policy-select').value;
            switch(policySelect) {
                case 'LEAST_TIME': return AMap.TransferPolicy.LEAST_TIME;
                case 'LEAST_SWAP': return AMap.TransferPolicy.LEAST_SWAP;
                case 'LEAST_WALK': return AMap.TransferPolicy.LEAST_WALK;
                case 'MOST_COMFORT': return AMap.TransferPolicy.MOST_COMFORT;
                case 'NO_SUBWAY': return AMap.TransferPolicy.NO_SUBWAY;
                default: return AMap.TransferPolicy.LEAST_TIME;
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatDuration(seconds) {
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return hours + 'Â∞èÊó∂' + minutes + 'ÂàÜÈíü';
            } else {
                return minutes + 'ÂàÜÈíü';
            }
        }
        
        // Ê†ºÂºèÂåñË∑ùÁ¶ª
        function formatDistance(meters) {
            if (meters >= 1000) {
                return (meters / 1000).toFixed(1) + 'ÂÖ¨Èáå';
            } else {
                return Math.round(meters) + 'Á±≥';
            }
        }
        
        // Ëé∑ÂèñÊ≠•È™§ÂõæÊ†á
        function getStepIcon(instruction) {
            if (instruction.indexOf('Ê≠•Ë°å') >= 0 || instruction.indexOf('Ëµ∞Ë∑Ø') >= 0) {
                return 'walk';
            } else if (instruction.indexOf('Âú∞ÈìÅ') >= 0 || instruction.indexOf('MTR') >= 0) {
                return 'metro';
            } else {
                return 'bus';
            }
        }
        
        // Ëé∑Âèñ‰∫§ÈÄöÊñπÂºèÊëòË¶Å
        function getTransportSummary(segments) {
            var transportTypes = [];
            var hasWalking = false;
            
            segments.forEach(function(segment) {
                if (segment.transit_mode === 'WALK') {
                    hasWalking = true;
                } else if (segment.transit_mode === 'SUBWAY') {
                    if (!transportTypes.includes('Âú∞ÈìÅ')) {
                        transportTypes.push('Âú∞ÈìÅ');
                    }
                } else if (segment.transit_mode === 'BUS') {
                    if (!transportTypes.includes('ÂÖ¨‰∫§')) {
                        transportTypes.push('ÂÖ¨‰∫§');
                    }
                }
            });
            
            if (hasWalking && transportTypes.length > 0) {
                transportTypes.push('Ê≠•Ë°å');
            } else if (hasWalking) {
                transportTypes = ['Ê≠•Ë°å'];
            }
            
            return transportTypes;
        }
        
        // ËÆ°ÁÆóÊ≠•Ë°åÊÄªË∑ùÁ¶ª
        function getWalkingDistance(segments) {
            var walkingDistance = 0;
            segments.forEach(function(segment) {
                if (segment.transit_mode === 'WALK' && segment.distance) {
                    walkingDistance += segment.distance;
                }
            });
            return walkingDistance;
        }
        
        // Ëé∑ÂèñÈ´òÂæ∑APIËøîÂõûÁöÑÂÆûÈôÖË¥πÁî®
        function getActualCost(route) {
            // È´òÂæ∑APIËøîÂõûÁöÑÊï∞ÊçÆ‰∏≠ÔºåË¥πÁî®‰ø°ÊÅØÈÄöÂ∏∏Âú®routeÂØπË±°ÁöÑÊüê‰∏™Â±ûÊÄß‰∏≠
            // Ê†πÊçÆÈ´òÂæ∑Âú∞ÂõæÊñáÊ°£ÔºåË¥πÁî®‰ø°ÊÅØÈÄöÂ∏∏Âú®route.costÂ±ûÊÄß‰∏≠
            if (route.cost !== undefined && route.cost !== null) {
                return route.cost;
            }
            
            // Â¶ÇÊûúroute.cost‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ªésegments‰∏≠Êü•ÊâæË¥πÁî®‰ø°ÊÅØ
            var totalCost = 0;
            if (route.segments && route.segments.length > 0) {
                route.segments.forEach(function(segment) {
                    if (segment.cost !== undefined && segment.cost !== null) {
                        totalCost += segment.cost;
                    }
                });
                return totalCost > 0 ? totalCost : null;
            }
            
            // Â¶ÇÊûúÈÉΩÊ≤°ÊúâÊâæÂà∞Ë¥πÁî®‰ø°ÊÅØÔºåËøîÂõûnull
            return null;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶‰∏∫Á´ôÂÜÖÊç¢‰πòÔºàÊ≠•Ë°åÂâçÂêéÈÉΩÊòØÂú∞ÈìÅÔºå‰∏îÂâç‰∏Ä‰∏™Âú∞ÈìÅÊ≤°ÊúâÂá∫Á´ôÂè£Ôºâ
        function checkStationTransfer(allSegments, currentIndex) {
            // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™ÊàñÊúÄÂêé‰∏Ä‰∏™Ê≠•Ë°åË∑ØÊÆµÔºå‰∏çÂèØËÉΩÊòØÁ´ôÂÜÖÊç¢‰πò
            if (currentIndex === 0 || currentIndex === allSegments.length - 1) {
                return false;
            }
            
            var prevSegment = allSegments[currentIndex - 1];
            var nextSegment = allSegments[currentIndex + 1];
            
            // ‰∏•Ê†ºÊ£ÄÊü•Ââç‰∏Ä‰∏™Ë∑ØÊÆµÊòØÂê¶‰∏∫Âú∞ÈìÅÔºàÂè™Ê†πÊçÆtransit_modeÂà§Êñ≠Ôºâ
            var prevIsSubway = prevSegment && prevSegment.transit_mode === 'SUBWAY';
            
            // ‰∏•Ê†ºÊ£ÄÊü•Âêé‰∏Ä‰∏™Ë∑ØÊÆµÊòØÂê¶‰∏∫Âú∞ÈìÅÔºàÂè™Ê†πÊçÆtransit_modeÂà§Êñ≠Ôºâ
            var nextIsSubway = nextSegment && nextSegment.transit_mode === 'SUBWAY';
            
            // Ê£ÄÊü•Ââç‰∏Ä‰∏™Âú∞ÈìÅË∑ØÊÆµÊòØÂê¶ÊúâÂá∫Á´ôÂè£‰ø°ÊÅØÔºàÂè™Ê†πÊçÆtransit.exitÂ±ûÊÄßÂà§Êñ≠Ôºâ
            var prevHasExit = false;
            if (prevIsSubway && prevSegment && prevSegment.transit && prevSegment.transit.exit && prevSegment.transit.exit.name) {
                prevHasExit = true;
            }
                        
            // Âè™ÊúâÂΩìÂâçÂêéÈÉΩÊòØÂú∞ÈìÅ‰∏îÂâç‰∏Ä‰∏™Âú∞ÈìÅÊ≤°ÊúâÂá∫Á´ôÂè£Êó∂ÔºåÊâçÊòØÁ´ôÂÜÖÊç¢‰πò
            return prevIsSubway && nextIsSubway && !prevHasExit;
        }
        
        // Ê†ºÂºèÂåñÂÖ¨‰∫§Ë∑ØÊÆµÁöÑÊòæÁ§∫ÂÜÖÂÆπ
        function formatBusInstruction(segment) {
            try {
                var instruction = segment.instruction || '';
                
                // Â∞ùËØï‰ªé‰∏çÂêåÂ≠óÊÆµÊèêÂèñÂÖ¨‰∫§‰ø°ÊÅØ
                var busInfo = {
                    line: '',          // ÂÖ¨‰∫§Á∫øË∑Ø
                    direction: '',     // ÊñπÂêë
                    stations: '',      // ‰πòÂùêÁ´ôÊï∞
                    exit: ''          // Âá∫Á´ôÂè£
                };
                
                // Áõ¥Êé•‰ªétransit.linesÊï∞ÁªÑËé∑ÂèñÊâÄÊúâÁ∫øË∑ØÂêçÁß∞
                if (segment.transit && segment.transit.lines && segment.transit.lines.length > 0) {
                    var lineNames = [];
                    for (var i = 0; i < segment.transit.lines.length; i++) {
                        var line = segment.transit.lines[i];
                        if (line.name) {
                            var lineName = line.name;
                            // Â¶ÇÊûúÁ∫øË∑ØÊï∞ÈáèË∂ÖËøá‰∏§‰∏™ÔºåÂéªÊéâÊØè‰∏™Á∫øË∑ØÂêçÁß∞‰∏≠Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ
                            if (segment.transit.lines.length > 2) {
                                lineName = lineName.replace(/\([^)]*\)/g, '');
                            }
                            lineNames.push(lineName);
                        }
                    }
                    if (lineNames.length > 0) {
                        busInfo.line = lineNames.join('/');
                    }
                }
                
                // ‰ºòÂÖà‰ªévia_stops‰∏≠ÊèêÂèñÊñπÂêë‰ø°ÊÅØÔºà‰∏ã‰∏Ä‰∏™Á´ôÁÇπÁöÑÂêçÁß∞Ôºâ
                if (segment.transit && segment.transit.via_stops && segment.transit.via_stops.length > 0) {
                    // Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™ÈÄîÂæÑÁ´ôÁÇπÁöÑÂêçÁß∞‰Ωú‰∏∫ÊñπÂêë
                    var nextStop = segment.transit.via_stops[0];
                    if (nextStop && nextStop.name) {
                        busInfo.direction = nextStop.name;
                    } else if (segment.transit.off_station) {
                        busInfo.direction = segment.transit.off_station.name;
                    }
                } else {
                    busInfo.direction = segment.transit.off_station.name;
                }
                
                // Â∞ùËØïËé∑ÂèñËµ∑ÁÇπÂíåÁªàÁÇπÁ´ô
                if (segment.transit) {
                    if (segment.transit.on_station) {
                        busInfo.fromStation = segment.transit.on_station.name;
                    }
                    if (segment.transit.off_station) {
                        busInfo.off_station = segment.transit.off_station.name + 'Á´ô';
                    }
                }
                
                // ÊûÑÂª∫Ê†ºÂºèÂåñÊåá‰ª§
                var parts = [];
                
                if (busInfo.line) {
                    parts.push(busInfo.line);
                }
                
                if (busInfo.direction) {
                    parts.push('‰∏ã‰∏ÄÁ´ôÔºö' + busInfo.direction);
                }
                
                if (busInfo.stations) {
                    parts.push('‰πòÂùê' + busInfo.stations);
                }
                
                var result = parts.join('Ôºå');
                
                return result || instruction; // Â¶ÇÊûúÊ†ºÂºèÂåñÂ§±Ë¥•ÔºåËøîÂõûÂéüÂßãÊåá‰ª§
                
            } catch (error) {
                return segment.instruction; // Âá∫ÈîôÊó∂ËøîÂõûÂéüÂßãÊåá‰ª§
            }
        }

        // Ê†ºÂºèÂåñÂú∞ÈìÅË∑ØÊÆµÁöÑÊòæÁ§∫ÂÜÖÂÆπ
        function formatSubwayInstruction(segment) {
            try {
                var instruction = segment.instruction || '';
                
                // Â∞ùËØï‰ªé‰∏çÂêåÂ≠óÊÆµÊèêÂèñÂú∞ÈìÅ‰ø°ÊÅØ
                var subwayInfo = {
                    line: '',          // Âú∞ÈìÅÁ∫øË∑Ø
                    direction: '',     // ÊñπÂêë
                    stations: '',      // ‰πòÂùêÁ´ôÊï∞
                    exit: ''          // Âá∫Á´ôÂè£
                };
                                           
                // Áõ¥Êé•‰ªétransit.linesÊï∞ÁªÑËé∑ÂèñÊâÄÊúâÁ∫øË∑ØÂêçÁß∞
                if (segment.transit && segment.transit.lines && segment.transit.lines.length > 0) {
                    var lineNames = [];
                    for (var i = 0; i < segment.transit.lines.length; i++) {
                        var line = segment.transit.lines[i];
                        if (line.name) {
                            var lineName = line.name;
                            // Â¶ÇÊûúÁ∫øË∑ØÊï∞ÈáèË∂ÖËøá‰∏§‰∏™ÔºåÂéªÊéâÊØè‰∏™Á∫øË∑ØÂêçÁß∞‰∏≠Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ
                            if (segment.transit.lines.length > 2) {
                                lineName = lineName.replace(/\([^)]*\)/g, '');
                            }
                            lineNames.push(lineName);
                        }
                    }
                    if (lineNames.length > 0) {
                        subwayInfo.line = lineNames.join('/');
                    }
                }
                
                // Â∞ùËØïËé∑ÂèñËµ∑ÁÇπÂíåÁªàÁÇπÁ´ô
                if (segment.transit) {
                    if (segment.transit.on_station) {
                        subwayInfo.fromStation = segment.transit.on_station.name;
                    }
                    if (segment.transit.off_station) {
                        subwayInfo.off_station = segment.transit.off_station.name + 'Á´ô';
                    }
                }

                // ‰ºòÂÖà‰ªévia_stops‰∏≠ÊèêÂèñÊñπÂêë‰ø°ÊÅØÔºà‰∏ã‰∏Ä‰∏™Á´ôÁÇπÁöÑÂêçÁß∞Ôºâ
                if (segment.transit && segment.transit.via_stops && segment.transit.via_stops.length > 0) {
                    // Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™ÈÄîÂæÑÁ´ôÁÇπÁöÑÂêçÁß∞‰Ωú‰∏∫ÊñπÂêë
                    var nextStop = segment.transit.via_stops[0];
                    if (nextStop && nextStop.name) {
                        subwayInfo.direction = nextStop.name;

                    } 
                }  else {
                    subwayInfo.direction = subwayInfo.off_station;
                }    
                

                
                // ÊûÑÂª∫Ê†ºÂºèÂåñÊåá‰ª§
                var parts = [];
                
                if (subwayInfo.line) {
                    parts.push(subwayInfo.line);
                }
                
                if (subwayInfo.direction) {
                    parts.push('‰∏ã‰∏ÄÁ´ôÔºö' + subwayInfo.direction);
                }
                
                
                
                var result = parts.join('Ôºå');
                
                
                return result || instruction; // Â¶ÇÊûúÊ†ºÂºèÂåñÂ§±Ë¥•ÔºåËøîÂõûÂéüÂßãÊåá‰ª§
                
            } catch (error) {

                return segment.instruction; // Âá∫ÈîôÊó∂ËøîÂõûÂéüÂßãÊåá‰ª§
            }
        }
        
        // ÁîüÊàêÊ≠•Ë°åOMÈìæÊé•
        function generateWalkOMLink(segment) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ≠•Ë°åË∑ØÊÆµ
            if (!segment.transit_mode || segment.transit_mode !== 'WALK') {
                return '';
            }
            

            
            // ‰ªé‰∏çÂêåÂèØËÉΩÁöÑÂ±ûÊÄßËé∑ÂèñÂùêÊ†á
            var startLocation = null;
            var endLocation = null;
            

            
            // Â∞ùËØï‰ªéoriginËé∑ÂèñËµ∑ÁÇπÂùêÊ†á
            if (segment.transit && segment.transit.origin) {

                
                // Â¶ÇÊûúÊòØÊï∞ÁªÑÊ†ºÂºè [lng, lat]
                if (Array.isArray(segment.transit.origin) && segment.transit.origin.length >= 2) {
                    startLocation = {
                        lng: segment.transit.origin[0],
                        lat: segment.transit.origin[1]
                    };

                } 
                // Â¶ÇÊûúÊòØÂØπË±°Ê†ºÂºè {lng: xxx, lat: xxx} Êàñ {longitude: xxx, latitude: xxx}
                else if (typeof segment.transit.origin === 'object') {
                    var lng = segment.transit.origin.lng || segment.transit.origin.longitude;
                    var lat = segment.transit.origin.lat || segment.transit.origin.latitude;
                    if (typeof lng === 'number' && typeof lat === 'number') {
                        startLocation = {
                            lng: lng,
                            lat: lat
                        };

                    }
                }
            }
            
            // Â∞ùËØï‰ªédestinationËé∑ÂèñÁªàÁÇπÂùêÊ†á
            if (segment.transit && segment.transit.destination) {

                
                // Â¶ÇÊûúÊòØÊï∞ÁªÑÊ†ºÂºè [lng, lat]
                if (Array.isArray(segment.transit.destination) && segment.transit.destination.length >= 2) {
                    endLocation = {
                        lng: segment.transit.destination[0],
                        lat: segment.transit.destination[1]
                    };

                } 
                // Â¶ÇÊûúÊòØÂØπË±°Ê†ºÂºè {lng: xxx, lat: xxx} Êàñ {longitude: xxx, latitude: xxx}
                else if (typeof segment.transit.destination === 'object') {
                    var lng = segment.transit.destination.lng || segment.transit.destination.longitude;
                    var lat = segment.transit.destination.lat || segment.transit.destination.latitude;
                    if (typeof lng === 'number' && typeof lat === 'number') {
                        endLocation = {
                            lng: lng,
                            lat: lat
                        };

                    }
                }
            }
            
            // Â¶ÇÊûúËøòÊ≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØï‰ªéstepsÁöÑË∑ØÂæÑ‰∏≠Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™ÂíåÊúÄÂêé‰∏Ä‰∏™ÁÇπ
            if ((!startLocation || !endLocation) && segment.transit && segment.transit.steps && segment.transit.steps.length > 0) {

                
                if (!startLocation) {
                    var firstStep = segment.transit.steps[0];
                    if (firstStep.path && firstStep.path.length > 0) {
                        var firstPath = firstStep.path[0];
                        if (Array.isArray(firstPath) && firstPath.length >= 2) {
                            startLocation = {
                                lng: firstPath[0],
                                lat: firstPath[1]
                            };

                        }
                    }
                }
                
                if (!endLocation) {
                    var lastStep = segment.transit.steps[segment.transit.steps.length - 1];
                    if (lastStep.path && lastStep.path.length > 0) {
                        var lastPath = lastStep.path[lastStep.path.length - 1];
                        if (Array.isArray(lastPath) && lastPath.length >= 2) {
                            endLocation = {
                                lng: lastPath[0],
                                lat: lastPath[1]
                            };

                        }
                    }
                }
            }
            
            if (!startLocation || !endLocation) {

                return '';
            }
            

            
            var startGcjLat = startLocation.lat;
            var startGcjLng = startLocation.lng;
            var endGcjLat = endLocation.lat;
            var endGcjLng = endLocation.lng;
            

            
            // Ê£ÄÊü•ÂùêÊ†áÊòØÂê¶‰∏∫ÊúâÊïàÊï∞Â≠ó
            if (isNaN(startGcjLat) || isNaN(startGcjLng) || isNaN(endGcjLat) || isNaN(endGcjLng)) {

                return '';
            }
            
            try {
                // ËΩ¨Êç¢‰∏∫WGS-84ÂùêÊ†á
                var startWgs = gcj2wgs_exact(startGcjLat, startGcjLng);
                var endWgs = gcj2wgs_exact(endGcjLat, endGcjLng);
                

                
                // Ê£ÄÊü•ËΩ¨Êç¢ÂêéÁöÑÂùêÊ†áÊòØÂê¶ÊúâÊïà
                if (isNaN(startWgs.lat) || isNaN(startWgs.lng) || isNaN(endWgs.lat) || isNaN(endWgs.lng)) {

                    return '';
                }
                
                // ÊûÑÂª∫Ëµ∑ÁÇπÂíåÁªàÁÇπÂú∞ÂùÄ
                var saddr = 'Ê≠•Ë°åËµ∑ÁÇπ';
                var daddr = 'Ê≠•Ë°åÁªàÁÇπ';
                
                // ‰ªéinstruction‰∏≠ÊèêÂèñÂú∞ÁÇπ‰ø°ÊÅØ
                var instruction = segment.instruction || '';
                if (instruction) {
                    // Â∞ùËØï‰ªéÊåá‰ª§‰∏≠ÊèêÂèñÂú∞ÁÇπÂêçÁß∞
                    var matches = instruction.match(/Âà∞Ëææ(.+)/);
                    if (matches && matches[1]) {
                        daddr = matches[1].trim();
                    }
                }
                
                // ÁºñÁ†ÅÂú∞ÂùÄ
                saddr = encodeURIComponent(saddr);
                daddr = encodeURIComponent(daddr);
                
                // ÁîüÊàêOMÈìæÊé•
                var omLink = 'om://route?sll=' + startWgs.lat.toFixed(7) + ',' + startWgs.lng.toFixed(7) + 
                            '&saddr=' + saddr + '&dll=' + endWgs.lat.toFixed(7) + ',' + endWgs.lng.toFixed(7) + 
                            '&daddr=' + daddr + '&type=pedestrian';
                

                return '<a href="' + omLink + '" class="om-walk-link" title="Âú®OM‰∏≠ÊâìÂºÄÊ≠•Ë°åÂØºËà™">ÂØºËà™</a>';
                
            } catch (error) {

                return '';
            }
        }
        
        // Ê∏≤ÊüìÂÖ¨‰∫§Á´ôÁÇπÂàóË°®
        function renderBusStops(segment, segmentIndex, stepIndex) {
            
            var uniqueId = 'bus-stops-' + segmentIndex + '-' + stepIndex;
            var stops = segment.transit.via_stops;
            var stopsHtml = '';
            
            // Ê∑ªÂä†on_station‰Ωú‰∏∫Á¨¨‰∏ÄÁ´ôÔºà‰∏äËΩ¶Á´ôÔºâ
            if (segment.transit.on_station && segment.transit.on_station.name) {
                var onStationName = segment.transit.on_station.name;
                stopsHtml += `<div class="subway-stop-item" style="border-left-color: #dcdcaa; font-weight: bold;">${onStationName}</div>`;
            }
            
            // ÁîüÊàêÁ´ôÁÇπÂàóË°®
            stops.forEach(function(stop, index) {
                stopsHtml += `<div class="subway-stop-item">${stop.name}</div>`;
            });
            
            // Ê∑ªÂä†off_station‰Ωú‰∏∫ÊúÄÂêé‰∏ÄÁ´ô
            if (segment.transit.off_station && segment.transit.off_station.name) {
                var offStationName = segment.transit.off_station.name;               
                stopsHtml += `<div class="subway-stop-item"  style="border-left-color: #dcdcaa; font-weight: bold;">${offStationName}</div>`;
            }
            
            // ËÆ°ÁÆóÊÄªÁ´ôÁÇπÊï∞ÔºàÂåÖÊã¨on_stationÂíåoff_stationÔºâ
            var totalStops = stops.length;
            if (segment.transit.on_station && segment.transit.on_station.name) {
                totalStops++;
            }
            if (segment.transit.off_station && segment.transit.off_station.name) {
                totalStops++;
            }
            // ÈÄîÁªèÁ´ôÁÇπÊï∞ = ÊÄªÁ´ôÁÇπÊï∞ - 1ÔºàÂéªÊéâ‰∏äËΩ¶Á´ôÂíå‰∏ãËΩ¶Á´ôÔºâ
            var viaStopsCount = Math.max(0, totalStops - 1);
            
            // ÊûÑÂª∫‰∏ãËΩ¶Á´ô‰ø°ÊÅØÔºàÁ±ª‰ººÂú∞ÈìÅÁöÑÂ§ÑÁêÜÊñπÂºèÔºâ
            var stationInfoHtml = '';
            if (segment.transit.off_station && segment.transit.off_station.name) {
                var offStationName = segment.transit.off_station.name;
                stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;">‰∏ãËΩ¶Á´ôÔºö ${offStationName}</div>`;
            }
            
            return `
                <div class="subway-stops">
                    <div class="subway-stops-header" onclick="toggleBusStops('${uniqueId}')">
                        ‚ñ∂ ‰πòÂùê ${viaStopsCount} Á´ô
                    </div>
                    <div id="${uniqueId}" class="subway-stops-list">
                        ${stopsHtml}
                    </div>
                </div>
                ${stationInfoHtml}
            `;
        }

        // Ê∏≤ÊüìÂú∞ÈìÅÁ´ôÁÇπÂàóË°®
        function renderSubwayStops(segment, segmentIndex, stepIndex) {
            
            var uniqueId = 'subway-stops-' + segmentIndex + '-' + stepIndex;
            var stops = segment.transit.via_stops;
            var stopsHtml = '';
            
            // Ê∑ªÂä†on_station‰Ωú‰∏∫Á¨¨‰∏ÄÁ´ôÔºà‰∏äËΩ¶Á´ôÔºâ
            if (segment.transit.on_station && segment.transit.on_station.name) {
                var onStationName = segment.transit.on_station.name;
                stopsHtml += `<div class="subway-stop-item" style="border-left-color: #CE9178; font-weight: bold;">${onStationName}</div>`;
            }
            
            // ÁîüÊàêÁ´ôÁÇπÂàóË°®
            stops.forEach(function(stop, index) {
                stopsHtml += `<div class="subway-stop-item">${stop.name}</div>`;
            });
            
            // Ê∑ªÂä†off_station‰Ωú‰∏∫ÊúÄÂêé‰∏ÄÁ´ô
            if (segment.transit.off_station && segment.transit.off_station.name) {
                var offStationName = segment.transit.off_station.name;
                stopsHtml += `<div class="subway-stop-item"  style="border-left-color: #dcdcaa; font-weight: bold;">${offStationName}</div>`;
            }
            
            // ËÆ°ÁÆóÊÄªÁ´ôÁÇπÊï∞ÔºàÂåÖÊã¨on_stationÂíåoff_stationÔºâ
            var totalStops = stops.length;
            if (segment.transit.on_station && segment.transit.on_station.name) {
                totalStops++;
            }
            if (segment.transit.off_station && segment.transit.off_station.name) {
                totalStops++;
            }
            // ÈÄîÁªèÁ´ôÁÇπÊï∞ = ÊÄªÁ´ôÁÇπÊï∞ - 1ÔºàÂéªÊéâ‰∏äËΩ¶Á´ôÂíå‰∏ãËΩ¶Á´ôÔºâ
            var viaStopsCount = Math.max(0, totalStops - 1);
            
            // ÊûÑÂª∫‰∏ãËΩ¶Á´ôÂíåÂá∫Á´ôÂè£‰ø°ÊÅØ
            var stationInfoHtml = '';
            if (segment.transit.off_station && segment.transit.off_station.name) {
                var offStationName = segment.transit.off_station.name;
                
                
                // Ê∑ªÂä†Âá∫Á´ôÂè£‰ø°ÊÅØ
                var exitInfo = '';
                if (segment.transit.exit && segment.transit.exit.name) {
                    exitInfo = segment.transit.exit.name;
                } else {
                    // Â∞ùËØï‰ªéÊåá‰ª§‰∏≠ÊèêÂèñÂá∫Á´ôÂè£‰ø°ÊÅØ
                    var instruction = segment.instruction || '';
                    var exitMatch = instruction.match(/([A-Z0-9]+Âè∑?Âá∫Á´ôÂè£|[A-Z0-9]+Âá∫Á´ôÂè£|Âá∫Á´ôÂè£[A-Z0-9]+)/i);
                    if (exitMatch) {
                        exitInfo = exitMatch[1];
                    }
                }
                if (exitInfo!="") {
                    stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #c586c0;font-size: 12px;">‰∏ãËΩ¶Á´ôÔºö ${offStationName}&nbsp;&nbsp;&nbsp;&nbsp;Âá∫Á´ôÂè£: ${exitInfo}</div>`;
                } else {
                    stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #c586c0;font-size: 12px;">‰∏ãËΩ¶Á´ôÔºö ${offStationName}</div>`;
                }
                
            }
            
            return `
                <div class="subway-stops">
                    <div class="subway-stops-header" onclick="toggleSubwayStops('${uniqueId}')">
                        ‚ñ∂ ‰πòÂùê ${viaStopsCount} Á´ô
                    </div>
                    <div id="${uniqueId}" class="subway-stops-list">
                        ${stopsHtml}
                    </div></div>
                    ${stationInfoHtml}
                
            `;
        }
        
        // ÂàáÊç¢ÂÖ¨‰∫§Á´ôÁÇπÂàóË°®ÊòæÁ§∫
        function toggleBusStops(uniqueId) {
            var stopsList = document.getElementById(uniqueId);
            
            // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (!stopsList) {
                console.warn('ÂÖ¨‰∫§Á´ôÁÇπÂàóË°®ÂÖÉÁ¥†Êú™ÊâæÂà∞: ' + uniqueId);
                return;
            }
            
            var header = stopsList.previousElementSibling;
            
            // Ê£ÄÊü•headerÊòØÂê¶Â≠òÂú®
            if (!header) {
                console.warn('ÂÖ¨‰∫§Á´ôÁÇπÂàóË°®Â§¥ÈÉ®ÂÖÉÁ¥†Êú™ÊâæÂà∞');
                return;
            }
            
            var isExpanded = stopsList.classList.contains('expanded');
            var stopsCount = Math.max(0, stopsList.children.length - 1); // ÂáèÂéªËµ∑ÂßãÁ´ôÔºåÊòæÁ§∫ÈÄîÂæÑÁ´ôÊï∞
            
            if (isExpanded) {
                stopsList.classList.remove('expanded');
                header.innerHTML = '‚ñ∂ ‰πòÂùê ' + stopsCount + ' Á´ô';
            } else {
                stopsList.classList.add('expanded');
                header.innerHTML = '‚ñº ‰πòÂùê ' + stopsCount + ' Á´ô';
            }
        }

        // ÂàáÊç¢Âú∞ÈìÅÁ´ôÁÇπÂàóË°®ÊòæÁ§∫
        function toggleSubwayStops(uniqueId) {
            var stopsList = document.getElementById(uniqueId);
            
            // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (!stopsList) {
                console.warn('Âú∞ÈìÅÁ´ôÁÇπÂàóË°®ÂÖÉÁ¥†Êú™ÊâæÂà∞: ' + uniqueId);
                return;
            }
            
            var header = stopsList.previousElementSibling;
            
            // Ê£ÄÊü•headerÊòØÂê¶Â≠òÂú®
            if (!header) {
                console.warn('Âú∞ÈìÅÁ´ôÁÇπÂàóË°®Â§¥ÈÉ®ÂÖÉÁ¥†Êú™ÊâæÂà∞');
                return;
            }
            
            var isExpanded = stopsList.classList.contains('expanded');
            var stopsCount = Math.max(0, stopsList.children.length - 1); // ÂáèÂéªËµ∑ÂßãÁ´ôÔºåÊòæÁ§∫ÈÄîÂæÑÁ´ôÊï∞
            
            if (isExpanded) {
                stopsList.classList.remove('expanded');
                header.innerHTML = '‚ñ∂ ‰πòÂùê ' + stopsCount + ' Á´ô';
            } else {
                stopsList.classList.add('expanded');
                header.innerHTML = '‚ñº ‰πòÂùê ' + stopsCount + ' Á´ô';
            }
        }
        
        // Ê∏≤ÊüìË∑ØÁ∫øÊ≠•È™§
        function renderSteps(segments, routeIndex) {

            var stepsHtml = '<div class="route-steps-content">';
            
            segments.forEach(function(segment, index) {

                
                var iconClass = getStepIcon(segment.instruction);
                var iconText = iconClass === 'walk' ? 'Ê≠•' : (iconClass === 'metro' ? 'ÈìÅ' : 'ËΩ¶');
                
                // Ëé∑ÂèñÊ≠•È™§ÁöÑÂü∫Êú¨‰ø°ÊÅØ
                var durationInfo = segment.duration ? formatDuration(segment.duration) : '';
                var distanceInfo = segment.distance ? formatDistance(segment.distance) : '';
                var walkLink = '';
                
                // Â¶ÇÊûúÊòØÊ≠•Ë°åË∑ØÊÆµÔºåÊ£ÄÊü•ÊòØÂê¶‰∏∫Á´ôÂÜÖÊç¢‰πòÔºåÂê¶ÂàôÁîüÊàêOMÂØºËà™ÈìæÊé•
                if (segment.transit_mode === 'WALK') {

                    
                    // Ê£ÄÊü•ÂâçÂêéË∑ØÊÆµÊòØÂê¶ÈÉΩÊòØÂú∞ÈìÅ
                    var isStationTransfer = checkStationTransfer(segments, index);
                    
                    if (isStationTransfer) {
                        walkLink = '<span style="color: #c586c0; font-size: 12px;">Á´ôÂÜÖÊç¢‰πò</span>';

                    } else {
                        walkLink = generateWalkOMLink(segment);

                    }
                } else {

                }
                
                // Â§ÑÁêÜÂú∞ÈìÅË∑ØÊÆµÂíåÂÖ¨‰∫§Ë∑ØÊÆµÁöÑÁâπÊÆäÊòæÁ§∫Ê†ºÂºè
                var instruction = segment.instruction;
                var subwayStopsHtml = '';
                var busStopsHtml = '';
                
                // Â¶ÇÊûúÊòØÂú∞ÈìÅË∑ØÊÆµÔºåÈáçÊñ∞Ê†ºÂºèÂåñÊòæÁ§∫ÂÜÖÂÆπ
                if (segment.transit_mode === 'SUBWAY' || 
                    (segment.transit_mode === 'RAILWAY' && instruction.includes('Âú∞ÈìÅ')) ||
                    (instruction && (instruction.includes('Âú∞ÈìÅ') || instruction.includes('MTR')))) {
                    

                    
                    // Â∞ùËØï‰ªéÂú∞ÈìÅË∑ØÊÆµÊï∞ÊçÆ‰∏≠ÊèêÂèñ‰ø°ÊÅØÔºå‰ΩÜÂéªÈô§"‰πòÂùêXÁ´ô"ÈÉ®ÂàÜ
                    var formattedInstruction = formatSubwayInstruction(segment);
                    if (formattedInstruction) {
                        // ÁßªÈô§"‰πòÂùêXÁ´ô"ÈÉ®ÂàÜÔºåÂõ†‰∏∫Êàë‰ª¨Ë¶ÅÁî®ÂèØÊäòÂè†ÁöÑÁ´ôÁÇπÂàóË°®Êõø‰ª£
                        instruction = formattedInstruction.replace(/Ôºå‰πòÂùê\d+Á´ô/, '');

                    }
                    
                    // ÁîüÊàêÂú∞ÈìÅÁ´ôÁÇπÂàóË°®Ôºà‰ΩøÁî®routeIndexÊù•Á°Æ‰øùIDÂîØ‰∏ÄÊÄßÔºâ
                    subwayStopsHtml = renderSubwayStops(segment, routeIndex, index);
                }
                // Â¶ÇÊûúÊòØÂÖ¨‰∫§Ë∑ØÊÆµÔºåÈáçÊñ∞Ê†ºÂºèÂåñÊòæÁ§∫ÂÜÖÂÆπ
                else if (segment.transit_mode === 'BUS') {
                    
                    // Â∞ùËØï‰ªéÂÖ¨‰∫§Ë∑ØÊÆµÊï∞ÊçÆ‰∏≠ÊèêÂèñ‰ø°ÊÅØÔºå‰ΩÜÂéªÈô§"‰πòÂùêXÁ´ô"ÈÉ®ÂàÜ
                    var formattedInstruction = formatBusInstruction(segment);
                    if (formattedInstruction) {
                        // ÁßªÈô§"‰πòÂùêXÁ´ô"ÈÉ®ÂàÜÔºåÂõ†‰∏∫Êàë‰ª¨Ë¶ÅÁî®ÂèØÊäòÂè†ÁöÑÁ´ôÁÇπÂàóË°®Êõø‰ª£
                        instruction = formattedInstruction.replace(/Ôºå‰πòÂùê\d+Á´ô/, '').replace(/‰πòÂùê\d+Á´ôÔºå/, '').replace(/‰πòÂùê\d+Á´ô/, '');

                    }
                    
                    // ÁîüÊàêÂÖ¨‰∫§Á´ôÁÇπÂàóË°®Ôºà‰ΩøÁî®routeIndexÊù•Á°Æ‰øùIDÂîØ‰∏ÄÊÄßÔºâ
                    busStopsHtml = renderBusStops(segment, routeIndex, index);
                }
                
                var stepHtml = `
                    <div class="step-item">
                        <div class="step-icon ${iconClass}">${iconText}</div>
                        <div class="step-content">
                            <div class="step-instruction">${instruction}</div>
                            <div class="step-details">
                                <div>
                                    ${durationInfo} ${distanceInfo}
                                </div>
                                <div>
                                    ${walkLink}
                                </div>
                            </div>
                            ${subwayStopsHtml}
                            ${busStopsHtml}
                        </div>
                    </div>
                `;
                

                stepsHtml += stepHtml;
            });
            
            stepsHtml += '</div>';
            return stepsHtml;
        }
        
        // Ê∏≤ÊüìË∑ØÁ∫ø
        function renderRoute(route, index) {
            var transportTypes = getTransportSummary(route.segments);
            var actualCost = getActualCost(route);
            var walkingDistance = getWalkingDistance(route.segments);
            
            // ÁîüÊàê‰∫§ÈÄöÊñπÂºèÂæΩÁ´†
            var transportBadges = transportTypes.map(function(type) {
                var badgeClass = type === 'Ê≠•Ë°å' ? 'walk' : (type === 'Âú∞ÈìÅ' ? 'metro' : 'bus');
                return `<span class="transport-badge ${badgeClass}">${type}</span>`;
            }).join('');
            
            // Ê†πÊçÆÊòØÂê¶ÊúâË¥πÁî®‰ø°ÊÅØÊù•ÂÜ≥ÂÆöÊòæÁ§∫ÂÜÖÂÆπ
            var costDisplay = actualCost !== null && actualCost !== undefined ? 
                `<div class="route-cost">¬•${actualCost}</div>` : '';
            
            var routeHtml = `
                <div class="route-item" data-route-index="${index}">
                    <div class="route-header" onclick="toggleRoute(${index})">
                        <div class="route-title">
                            <div class="expand-icon" id="expand-icon-${index}"></div>
                            ÊñπÊ°à ${index + 1}
                        </div>
                        <div class="route-summary">
                            <div class="route-time">${formatDuration(route.time)}</div>
                            <div class="route-distance">${formatDistance(walkingDistance)}</div>
                            ${costDisplay}
                        </div>
                    </div>
                    <div class="route-steps" id="route-steps-${index}">
                        ${renderSteps(route.segments, index)}
                    </div>
                </div>
            `;
            return routeHtml;
        }
        
        // ÊäòÂè†/Â±ïÂºÄË∑ØÁ∫ø
        function toggleRoute(index) {
            var allRouteSteps = document.querySelectorAll('.route-steps');
            var allExpandIcons = document.querySelectorAll('.expand-icon');
            var allRouteHeaders = document.querySelectorAll('.route-header');
            
            // ÊäòÂè†ÊâÄÊúâÂÖ∂‰ªñË∑ØÁ∫ø
            for (var i = 0; i < allRouteSteps.length; i++) {
                if (i !== index) {
                    allRouteSteps[i].classList.remove('expanded');
                    allExpandIcons[i].classList.remove('expanded');
                    allRouteHeaders[i].classList.remove('expanded');
                }
            }
            
            // ÂàáÊç¢ÂΩìÂâçË∑ØÁ∫ø
            var currentSteps = document.getElementById('route-steps-' + index);
            var currentIcon = document.getElementById('expand-icon-' + index);
            var currentHeader = currentSteps.previousElementSibling;
            
            if (currentSteps.classList.contains('expanded')) {
                // Â¶ÇÊûúÂΩìÂâçÂ∑≤Â±ïÂºÄÔºåÂàôÊäòÂè†
                currentSteps.classList.remove('expanded');
                currentIcon.classList.remove('expanded');
                currentHeader.classList.remove('expanded');
            } else {
                // Â±ïÂºÄÂΩìÂâçË∑ØÁ∫ø
                currentSteps.classList.add('expanded');
                currentIcon.classList.add('expanded');
                currentHeader.classList.add('expanded');
            }
        }
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(message) {
            var errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(function() {
                errorDiv.classList.add('hidden');
            }, 5000);
        }
        
        // ÊêúÁ¥¢Ë∑ØÁ∫ø
        function searchRoute() {
            var city = getCurrentCity();
            var startKeyword = document.getElementById('startinput').value.trim();
            var endKeyword = document.getElementById('endinput').value.trim();
            
            // ‰øùÂ≠òËµ∑ÁªàÁÇπÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveStartEnd();
            
            if (!city) {
                showError('ËØ∑ËæìÂÖ•ÂüéÂ∏ÇÂêçÁß∞');
                return;
            }
            
            if (!startKeyword) {
                showError('ËØ∑ËæìÂÖ•Ëµ∑ÁÇπ');
                return;
            }
            
            if (!endKeyword) {
                showError('ËØ∑ËæìÂÖ•ÁªàÁÇπ');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('search-btn').disabled = true;
            
            // ÊêúÁ¥¢Ëµ∑ÁÇπÂíåÁªàÁÇπÂùêÊ†á
            var startSearchPromise = new Promise(function(resolve) {
                if (startLocation) {
                    resolve(startLocation);
                } else {
                    searchLocation(startKeyword, city, true, resolve);
                }
            });
            
            var endSearchPromise = new Promise(function(resolve) {
                if (endLocation) {
                    resolve(endLocation);
                } else {
                    searchLocation(endKeyword, city, false, resolve);
                }
            });
            
            Promise.all([startSearchPromise, endSearchPromise]).then(function(locations) {
                var startLoc = locations[0];
                var endLoc = locations[1];
                
                if (!startLoc || !endLoc) {
                    throw new Error('Êó†Ê≥ïÊâæÂà∞Ëµ∑ÁÇπÊàñÁªàÁÇπÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ');
                }
                
                // Ëé∑ÂèñÂá∫ÂèëÊó∂Èó¥
                var departureTime = getDepartureTimestamp();
                
                // ÂàõÂª∫ÂÖ¨‰∫§Ë∑ØÁ∫øËßÑÂàíÊúçÂä°
                var transfer = new AMap.Transfer({
                    policy: getPolicyValue(),
                    city: city,
                    nightflag: true
                });
                
                // ÊâßË°åË∑ØÁ∫øÊêúÁ¥¢
                // Ê≥®ÊÑèÔºöÈ´òÂæ∑Âú∞ÂõæAPIÁöÑtransfer.searchÊñπÊ≥ïÂØπ‰∫éÊó∂Èó¥ÂèÇÊï∞ÁöÑÂ§ÑÁêÜÊØîËæÉÁâπÊÆä
                // ÂÖà‰ΩøÁî®Ê†áÂáÜÁöÑÊêúÁ¥¢ÊñπÂºèÔºåÊó∂Èó¥ÂäüËÉΩÊöÇÊó∂Ê≥®ÈáäÊéâ‰ª•ÈÅøÂÖçÈîôËØØ
                transfer.search(startLoc, endLoc, function(status, result) {
                    handleTransferResult(status, result);
                });
                
                // Â¶ÇÊûúÈúÄË¶ÅÊîØÊåÅÂá∫ÂèëÊó∂Èó¥ÔºåÈúÄË¶Å‰ΩøÁî®Êõ¥Â§çÊùÇÁöÑÊñπÂºèÔºåÊöÇÊó∂Ê≥®ÈáäÊéâ
                /*
                if (departureTime) {
                    // ‰ΩøÁî®Â∏¶Êó∂Èó¥ÁöÑÊêúÁ¥¢ÔºàÈ´òÂæ∑APIÂèØËÉΩÈúÄË¶Å‰∏çÂêåÁöÑÂèÇÊï∞Ê†ºÂºèÔºâ

                }
                */
                
            }).catch(function(error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('search-btn').disabled = false;
                showError(error.message);

            });
        }
        
        // Â§ÑÁêÜË∑ØÁ∫øÊêúÁ¥¢ÁªìÊûú
        function handleTransferResult(status, result) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('search-btn').disabled = false;
            
            if (status === 'complete' && result.plans && result.plans.length > 0) {
                
                // ÊàêÂäüËé∑ÂèñË∑ØÁ∫øÔºåÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
                var startValue = document.getElementById('startinput').value.trim();
                var endValue = document.getElementById('endinput').value.trim();
                
                if (startValue) {
                    updateSearchHistory(startValue, startValue, 'start');
                }
                if (endValue) {
                    updateSearchHistory(endValue, endValue, 'end');
                }
                
                var routesHtml = '';
                result.plans.forEach(function(plan, index) {
                    routesHtml += renderRoute(plan, index);
                });
                
                document.getElementById('routes-container').innerHTML = routesHtml;
                document.getElementById('result').classList.remove('hidden');
                
            } else {
                showError('Ë∑ØÁ∫øËßÑÂàíÂ§±Ë¥•Ôºö' + (result.info || 'Êú™Áü•ÈîôËØØ'));
                
            }
        }
        
        // ÁªëÂÆöÊêúÁ¥¢ÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('search-btn').addEventListener('click', searchRoute);
        
        // ÁßªÈô§ÈáçÂ§çÁöÑÂõûËΩ¶‰∫ã‰ª∂Â§ÑÁêÜÔºåÂõ†‰∏∫ËæìÂÖ•ÊèêÁ§∫ÂäüËÉΩÂ∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÂõûËΩ¶ÈîÆ
        
        document.getElementById('cityinput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveCity(this.value);
                document.getElementById('startinput').focus();
            }
        });
        
        // Êõ¥Êñ∞ÊêúÁ¥¢ÊúçÂä°ÁöÑÂüéÂ∏Ç
        function updateSearchCity() {
            var city = getCurrentCity();
            if (city !== currentCity) {
                currentCity = city;
                setupAutocomplete();
            }
        }
    </script>
</body>
</html>