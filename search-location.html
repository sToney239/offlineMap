<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>位置搜索</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        
        .container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .input-item {
            margin-bottom: 20px;
        }
        
        .input-item-prepend {
            margin-bottom: 10px;
        }
        
        .input-item-text {
            font-weight: bold;
            color: #cccccc;
            font-size: 14px;
        }
        
        #cityinput, #tipinput {
            width: 100%;
            padding: 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #3c3c3c;
            color: #d4d4d4;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        #cityinput:focus, #tipinput:focus {
            outline: none;
            border-color: #0078d4;
            background-color: #404040;
        }
        
        #cityinput::placeholder, #tipinput::placeholder {
            color: #858585;
        }
        
        .result-container {
            margin-top: 20px;
            padding: 15px;
            border-left: 4px solid #0078d4;
        }
        
        .result-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #cccccc;
            font-size: 16px;
        }
        
        .result-info {
            margin: 5px 0;
            color: #9cdcfe;
            font-size: 13px;
        }
        
        .coordinates {
            font-family: Arial, sans-serif, 'Courier New', monospace;
            background-color: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            color: #ce9178;
        }
        
        .hidden {
            display: none;
        }
        
        .autocomplete-container {
            position: relative;
        }
        
        .amap-sug-result {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #252526;
            border: 1px solid #3e3e42;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 0 0 4px 4px;
        }
        
        .amap-sug-result .auto-item {
            padding: 8px 12px;
            color: #d4d4d4;
            cursor: pointer;
            border-bottom: 1px solid #3e3e42;
            font-family: Arial, sans-serif, 'Courier New', monospace;
            font-size: 13px;
        }
        
        .amap-sug-result .auto-item:hover {
            background-color: #3c3c3c;
        }
        
        .amap-sug-result .auto-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #cccccc; margin-bottom: 30px; font-weight: 300; font-size: 24px;">位置搜索工具</h1>
        
        <div class="input-item">
            <div class="input-item-prepend">
                <span class="input-item-text">选择城市</span>
            </div>
            <input id='cityinput' type="text" placeholder="输入城市名称（如：北京、上海）">
        </div>
        
        <div class="input-item">
            <div class="input-item-prepend">
                <span class="input-item-text">请输入关键字</span>
            </div>
            <div class="autocomplete-container">
                <input id='tipinput' type="text" placeholder="输入地址、地名或关键词...">
            </div>
        </div>
        
        <div id="result" class="result-container hidden">
            <div class="result-title">选中的位置信息</div>
            <div class="result-info">名称：<span id="location-name">-</span></div>
            <div class="result-info">地址：<span id="location-address">-</span></div>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #3e3e42;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #cccccc; font-size: 14px;">OM地图链接</div>
                <div class="result-info">
                    <a id="om-link" href="#" style="color: #569cd6; text-decoration: none; font-family: Arial, sans-serif, 'Courier New', monospace;">-</a>
                    <button id="copy-btn" style="margin-left: 6px; padding: 6px 8px; font-size: 12px; background-color: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial, sans-serif, 'Courier New', monospace; transition: background-color 0.2s;">复制</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入高德地图API 2.0 -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: 'your_security_js_code' // 需要配置安全密钥
        };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=你的高德apiKEY&plugin=AMap.AutoComplete,AMap.PlaceSearch"></script>
    
    <!-- 引入eviltransform库 -->
    <script type="text/javascript">
        // eviltransform.js - 坐标转换库
        // 来源：https://github.com/googollee/eviltransform/blob/master/javascript/transform.js
        
        function outOfChina(lat, lng) {
            if (lng < 72.004 || lng > 137.8347)
                return true;
            if (lat < 0.8293 || lat > 55.8271)
                return true;
            return false;
        }
        var earthR = 6378137.0;
        function transform(x, y) {
            var xy = x * y;
            var absX = Math.sqrt(Math.abs(x));
            var xPi = x * Math.PI;
            var yPi = y * Math.PI;
            var d = 20.0*Math.sin(6.0*xPi) + 20.0*Math.sin(2.0*xPi);

            var lat = d;
            var lng = d;

            lat += 20.0*Math.sin(yPi) + 40.0*Math.sin(yPi/3.0);
            lng += 20.0*Math.sin(xPi) + 40.0*Math.sin(xPi/3.0);

            lat += 160.0*Math.sin(yPi/12.0) + 320*Math.sin(yPi/30.0);
            lng += 150.0*Math.sin(xPi/12.0) + 300.0*Math.sin(xPi/30.0);

            lat *= 2.0 / 3.0;
            lng *= 2.0 / 3.0;

            lat += -100.0 + 2.0*x + 3.0*y + 0.2*y*y + 0.1*xy + 0.2*absX;
            lng += 300.0 + x + 2.0*y + 0.1*x*x + 0.1*xy + 0.1*absX;

            return {lat: lat, lng: lng}
        }
        function delta(lat, lng) {
            var ee = 0.00669342162296594323;
            var d = transform(lng-105.0, lat-35.0);
            var radLat = lat / 180.0 * Math.PI;
            var magic = Math.sin(radLat);
            magic = 1 - ee*magic*magic;
            var sqrtMagic = Math.sqrt(magic);
            d.lat = (d.lat * 180.0) / ((earthR * (1 - ee)) / (magic * sqrtMagic) * Math.PI);
            d.lng = (d.lng * 180.0) / (earthR / sqrtMagic * Math.cos(radLat) * Math.PI);
            return d;
        }
        
        function gcj2wgs_exact(gcjLat, gcjLng) {
            var newLat = gcjLat, newLng = gcjLng;
            var oldLat = newLat, oldLng = newLng;
            var threshold = 1e-6; 

            for (var i = 0; i < 50; i++) {
                oldLat = newLat;
                oldLng = newLng;
                var d = delta(newLat, newLng);
                newLat = gcjLat - d.lat;
                newLng = gcjLng - d.lng;
                if (Math.max(Math.abs(oldLat - newLat), Math.abs(oldLng - newLng)) < threshold) {
                    break;
                }
            }
            return {lat: newLat, lng: newLng};
        }
    </script>
    
    <script type="text/javascript">
        // 加载时恢复上一次的城市选择
        window.addEventListener('DOMContentLoaded', function() {
            var savedCity = localStorage.getItem('selectedCity');
            if (savedCity) {
                document.getElementById('cityinput').value = savedCity;
            }
            
            // 初始化AMap 2.0 API
            if (window.AMap) {
                // 输入提示（带城市限制）
                auto = new AMap.AutoComplete({
                    input: "tipinput",
                    city: getCurrentCity(),
                    pageSize: 5
                });
                
                // 地点搜索服务
                placeSearch = new AMap.PlaceSearch({
                    pageSize: 5,
                    city: getCurrentCity()
                });
                
                // 绑定选中事件
                auto.on("select", function(e) {
                    // 显示选中结果
                    document.getElementById('result').classList.remove('hidden');
                    document.getElementById('location-name').textContent = e.poi.name;
                    document.getElementById('location-address').textContent = e.poi.district + e.poi.address;
                    
                    // 获取原始GCJ-02坐标
                    var gcjLat = e.poi.location.lat;
                    var gcjLng = e.poi.location.lng;
                    
                    // 转换为WGS-84坐标
                    var wgsCoords = gcj2wgs_exact(gcjLat, gcjLng);
                    
                    // 生成OM链接（纬度在前，经度在后）
                    var omLink = 'om://map?ll=' + wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);
                    
                    // 保存坐标格式（纬度,经度）
                    currentCoords = wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);
                    
                    // 显示OM链接
                    var omLinkElement = document.getElementById('om-link');
                    omLinkElement.textContent = omLink;
                    omLinkElement.setAttribute('href', omLink);
                });
            }
        });
        
        // 保存城市选择到localStorage
        function saveCity(city) {
            if (city && city.trim()) {
                localStorage.setItem('selectedCity', city.trim());
            }
        }
        
        // 城市输入框失去焦点时保存
        document.getElementById('cityinput').addEventListener('blur', function() {
            saveCity(this.value);
        });
        
        // 获取当前城市
        function getCurrentCity() {
            return document.getElementById('cityinput').value.trim() || '全国';
        }
        
        // 输入提示和地点搜索服务将在DOM加载完成后初始化
        var auto = null;
        var placeSearch = null;
        
        // 更新搜索服务的城市
        function updateSearchCity() {
            var city = getCurrentCity();
            if (auto && auto.setCity) {
                auto.setCity(city);
            }
            if (placeSearch && placeSearch.setCity) {
                placeSearch.setCity(city);
            }
        }
        
        // 全局变量存储当前坐标
        var currentCoords = '';
        
        // 监听选中事件
        if (auto && auto.on) {
            auto.on("select", function(e) {
            // 显示选中结果
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('location-name').textContent = e.poi.name;
            document.getElementById('location-address').textContent = e.poi.district + e.poi.address;
            
            // 获取原始GCJ-02坐标
            var gcjLat = e.poi.location.lat;
            var gcjLng = e.poi.location.lng;
            
            // 转换为WGS-84坐标
            var wgsCoords = gcj2wgs_exact(gcjLat, gcjLng);
            
            // 生成OM链接（纬度在前，经度在后）
            var omLink = 'om://map?ll=' + wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);
            
            // 保存坐标格式（纬度,经度）
            currentCoords = wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);
            
            // 显示OM链接
            var omLinkElement = document.getElementById('om-link');
            omLinkElement.textContent = omLink;
            omLinkElement.setAttribute('href', omLink);
            
            // 可选：在控制台输出详细信息
            // console.log('选中的位置信息：', e.poi);
            // console.log('GCJ-02坐标：', gcjLng, gcjLat);
            // console.log('WGS-84坐标：', wgsCoords.lng, wgsCoords.lat);
            // console.log('OM链接：', omLink);
            });
        } else if (auto && AMap.event) {
            // 兼容旧版本API
            AMap.event.addListener(auto, "select", function(e) {
                // 显示选中结果
                document.getElementById('result').classList.remove('hidden');
                document.getElementById('location-name').textContent = e.poi.name;
                document.getElementById('location-address').textContent = e.poi.district + e.poi.address;
                
                // 获取原始GCJ-02坐标
                var gcjLat = e.poi.location.lat;
                var gcjLng = e.poi.location.lng;
                
                // 转换为WGS-84坐标
                var wgsCoords = gcj2wgs_exact(gcjLat, gcjLng);
                
                // 生成OM链接（纬度在前，经度在后）
                var omLink = 'om://map?ll=' + wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);
                
                // 保存坐标格式（纬度,经度）
                currentCoords = wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);
                
                // 显示OM链接
                var omLinkElement = document.getElementById('om-link');
                omLinkElement.textContent = omLink;
                omLinkElement.setAttribute('href', omLink);
            });
        }
        
        // 城市输入框回车键更新搜索范围
        document.getElementById('cityinput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveCity(this.value);
                updateSearchCity();
                // 清空搜索框
                document.getElementById('tipinput').value = '';
                document.getElementById('tipinput').focus();
            }
        });
        
        // 添加回车键搜索功能
        document.getElementById('tipinput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                // 先更新城市范围
                updateSearchCity();
                
                var keyword = e.target.value.trim();
                if (keyword) {
                    placeSearch.search(keyword, function(status, result) {
                        if (status === 'complete' && result.poiList.pois.length > 0) {
                            var poi = result.poiList.pois[0];
                            document.getElementById('result').classList.remove('hidden');
                            document.getElementById('location-name').textContent = poi.name;
                            document.getElementById('location-address').textContent = poi.district + poi.address;
                            
                            if (poi.location) {
                                // 获取原始GCJ-02坐标
                                var gcjLat = poi.location.lat;
                                var gcjLng = poi.location.lng;
                                
                                // 转换为WGS-84坐标
                                var wgsCoords = gcj2wgs_exact(gcjLat, gcjLng);
                                
                                // 生成OM链接（纬度在前，经度在后）
                                var omLink = 'om://map?ll=' + wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);
                                
                                // 保存坐标格式（纬度,经度）
                                currentCoords = wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);
                                
                                // 显示OM链接
                                var omLinkElement = document.getElementById('om-link');
                                omLinkElement.textContent = omLink;
                                omLinkElement.setAttribute('href', omLink);
                                
                                // console.log('搜索结果：', poi);
                                // console.log('GCJ-02坐标：', gcjLng, gcjLat);
                                // console.log('WGS-84坐标：', wgsCoords.lng, wgsCoords.lat);
                                // console.log('OM链接：', omLink);
                            } else {
                                var omLinkElement = document.getElementById('om-link');
                                omLinkElement.textContent = '无数据';
                                omLinkElement.setAttribute('href', '#');
                            }
                        }
                    });
                }
            }
        });
        
        // 添加复制功能
        document.getElementById('copy-btn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var copyText = '';
            if (currentCoords) {
                copyText = currentCoords;
            } else {
                var omLinkElement = document.getElementById('om-link');
                var link = omLinkElement.getAttribute('href');
                if (link && link !== '#' && link !== '无数据') {
                    // 从链接中提取坐标
                    var match = link.match(/ll=([^,]+),([^&]+)/);
                    if (match) {
                        copyText = parseFloat(match[1]).toFixed(7) + ',' + parseFloat(match[2]).toFixed(7);
                    }
                }
            }
            
            if (copyText) {
                // 创建临时文本区域进行复制
                var tempTextArea = document.createElement('textarea');
                tempTextArea.value = copyText;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                
                // 改变按钮文本提示复制成功
                var btn = document.getElementById('copy-btn');
                var originalText = btn.textContent;
                btn.textContent = '已复制';
                btn.style.backgroundColor = '#0e6e0e';
                
                setTimeout(function() {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#0078d4';
                }, 2000);
            }
        });
    </script>
</body>
</html>